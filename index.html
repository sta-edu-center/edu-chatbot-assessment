<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>STA êµìœ¡ì„¼í„° | SW Testing Foundation ì´ìˆ˜ í‰ê°€</title>
  <style>

    :root{
      /* ---------- layout (updated responsive) ---------- */
      --stackH: 240px;               /* optionBar + bottomBar combined (JS updates) */
      --safeBottom: env(safe-area-inset-bottom, 0px);

      /* Light theme */
      --bg1:#f7f9ff;
      --bg2:#eef3ff;
      --card:#ffffff;
      --line:rgba(15,23,42,.12);
      --text:#0f172a;
      --muted:#475569;

      --bot:#f1f5ff;
      --me:#2563eb;
      --meText:#ffffff;

      --good:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;

      --shadow: 0 14px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      background:linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 70%);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    .wrap{
      max-width:760px;
      margin:0 auto;
      padding:14px 12px calc(var(--stackH) + 28px);
    }
    .topbar{
      position:sticky; top:0; z-index:30;
      padding:12px 0 10px;
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(247,249,255,.92) 0%, rgba(247,249,255,.70) 65%, rgba(247,249,255,0) 100%);
    }
    .title{margin:0;font-size:clamp(15px, 2.2vw, 18px);font-weight:900;letter-spacing:-0.01em}
    .subtitle{margin:4px 0 0;color:var(--muted);font-size:clamp(12px, 1.8vw, 13px);line-height:1.35}

    .panel{
      background:rgba(255,255,255,.88);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow:var(--shadow);
      margin-top:10px;
    }

    .grid{
      display:grid; gap:10px;
      grid-template-columns: 1fr;
    }
    @media(min-width:560px){
      .grid{grid-template-columns: 1fr 1fr;}
    }

    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.16);
      background:#ffffff;
      color:var(--text);
      outline:none;
      box-shadow: 0 1px 0 rgba(15,23,42,.02) inset;
      font-size:14px;
    }
    input::placeholder{color:rgba(15,23,42,.35)}
    input:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .btn{
      border:1px solid rgba(15,23,42,.14);
      background:rgba(15,23,42,.04);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      font-size:14px;
      line-height:1;
      min-height:44px;
      touch-action:manipulation;
    }
    .btn.primary{
      background:rgba(37,99,235,.10);
      border-color:rgba(37,99,235,.35);
      color:#0b2a77;
    }
    .btn.primary:hover{background:rgba(37,99,235,.14);border-color:rgba(37,99,235,.45)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px;line-height:1.5}
    .status{color:var(--muted);font-size:12px;margin-top:10px}

    /* Chat area */
    .chat{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap: clamp(3px, 0.9vw, 6px);
    }
    .bubble{
      display:inline-block;
      width:fit-content;
      /* smaller by default, grows as needed */
      max-width: min(74%, 420px);
      padding: clamp(6px, 1.2vw, 9px) clamp(8px, 1.6vw, 12px);
      border-radius:14px;
      border:1px solid var(--line);
      box-shadow: 0 8px 14px rgba(15,23,42,.06);
      white-space:pre-wrap;
      word-break:break-word;
      overflow-wrap:anywhere;
      line-height:1.45;
      font-size:clamp(13px, 2.0vw, 14px);
      letter-spacing:-0.01em;
    }
    .bot{
      align-self:flex-start;
      background:var(--bot);
      border-top-left-radius:10px;
    }
    .me{
      align-self:flex-end;
      background:var(--me);
      color:var(--meText);
      border-color:rgba(37,99,235,.40);
      border-top-right-radius:10px;
    }
    .meta{display:none;}
    /* Option bar (answers) */
    .optionBar{
      position:fixed;
      left:0; right:0;
      bottom:0; /* JS will offset via transform if needed */
      padding:12px 12px calc(12px + var(--safeBottom));
      background:rgba(255,255,255,.94);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(15,23,42,.08);
      z-index:25;
    }
    .optionInner{
      max-width:760px;
      margin:0 auto;
      display:grid;
      gap:10px;
    }
    .optionHint{
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .hintLeft, .hintRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .miniBtn{
      border:1px solid rgba(15,23,42,.14);
      background:rgba(15,23,42,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      min-height:36px;
      line-height:1;
    }
    .miniBtn:disabled{opacity:.5;cursor:not-allowed}

    .optionGrid{
      display:grid;
      gap:10px;
      grid-template-columns:1fr;
    }
    @media(min-width:700px){
      .optionGrid{grid-template-columns:1fr 1fr;}
    }
    .optionBtn{
      width:100%;
      text-align:left;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid rgba(37,99,235,.18);
      background:#ffffff;
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      box-shadow: 0 8px 16px rgba(15,23,42,.05);
      user-select:none;
      min-height:48px;
      font-size:14px;
      line-height:1.35;
      touch-action:manipulation;
    }
    .optionBtn:hover{border-color:rgba(37,99,235,.40); background:rgba(37,99,235,.04)}
    .optionBtn.selected{
      border-color:rgba(37,99,235,.70);
      background:rgba(37,99,235,.08);
    }

    /* Bottom action bar (nav + submit) */
    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + var(--safeBottom));
      background:linear-gradient(180deg, rgba(247,249,255,0) 0%, rgba(247,249,255,.84) 30%, rgba(247,249,255,.96) 100%);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(15,23,42,.08);
      z-index:26;
    }
    .bottomInner{
      max-width:760px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .progress{
      color:var(--muted);
      font-size:12px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#ffffff;
      color:var(--muted);
      font-size:12px;
      user-select:none;
      line-height:1.2;
    }

    /* Result */
    .resultCard{
      background:#ffffff;
      border:1px solid rgba(15,23,42,.12);
      border-radius:18px;
      padding:14px;
      margin-top:10px;
      box-shadow:var(--shadow);
    }
    .resultTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .big{font-size:20px;font-weight:1000}
    .badge{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      font-weight:1000;
      font-size:12px;
      background:#fff;
    }
    .badge.pass{background:rgba(22,163,74,.10);border-color:rgba(22,163,74,.30);color:var(--good)}
    .badge.fail{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.30);color:var(--bad)}
    .review{margin-top:12px;display:grid;gap:10px}
    .revItem{
      border-radius:16px;
      border:1px solid rgba(15,23,42,.12);
      padding:12px;
      background:#ffffff;
    }
    .revItem.good{border-color:rgba(22,163,74,.28);background:rgba(22,163,74,.04)}
    .revItem.bad{border-color:rgba(239,68,68,.28);background:rgba(239,68,68,.04)}
    .revHead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start}
    .small{font-size:12px;color:var(--muted);line-height:1.55}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .hidden{display:none !important}

    /* small phones */
    @media(max-width:380px){
      .panel{padding:12px}
      .bubble{max-width:94%; padding:10px 11px}
      .btn{padding:11px 12px}
      .optionBtn{padding:12px 12px}
    }

  
/* ===== Chat bubbles: responsive compact (v6) ===== */
.chat{ gap: clamp(3px, 0.9vw, 6px); }
.bubble{
  width: fit-content;
  max-width: min(74%, 420px);
  padding: clamp(6px, 1.2vw, 9px) clamp(8px, 1.6vw, 12px);
  line-height: 1.42;
  border-radius: 14px;
}
.bubble.bot{ max-width: min(78%, 460px); }
.bubble.me{ max-width: min(70%, 420px); }
@media (max-width: 420px){
  .chat{ gap: 4px; }
  .bubble{
    max-width: 92vw;
    padding: 7px 9px;
    font-size: 13px;
    line-height: 1.38;
  }
  .bubble.bot{ max-width: 92vw; }
  .meta{display:none;}
}
@media (max-width: 360px){
  .bubble{
    max-width: 92vw;
    padding: 8px 9px;
    font-size: 12.5px;
  }
}

</style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h1 class="title">STA êµìœ¡ì„¼í„° | SW Testing Foundation ì´ìˆ˜ í‰ê°€</h1>
      <div class="subtitle">      <div class="subtitle">ì´ 10ë¬¸í•­, 80ì  ì´ìƒ í†µê³¼, <br> ê²°ê³¼ëŠ” ìë™ìœ¼ë¡œ STAêµìœ¡ì„¼í„° DBì— ì €ì¥ë©ë‹ˆë‹¤. (ì €ì¥ ë  ë•Œê¹Œì§€ ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)</div>
</div>
    </div>

    <!-- Setup -->
    <div class="panel" id="setupPanel">
      <div class="grid">
        <div>
          <label>ì‘ì‹œì ì´ë¦„</label>
          <input id="name" placeholder="ì˜ˆ) í™ê¸¸ë™ / ì‚¬ë²ˆ ë“±" />
        </div>
        <div>
          <label>ì‘ì‹œ ì›”</label>
          <select id="runMonth"></select>
        </div>
        <div>
          <label>Pass ê¸°ì¤€</label>
          <input value="80ì  ì´ìƒ" disabled />
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="startBtn">ğŸš€ ì‹œí—˜ ì‹œì‘</button>
        <span class="hint">â€» ë¬¸ì œëŠ” ì±„íŒ…ì— í‘œì‹œë˜ê³ , ë³´ê¸°ëŠ” í™”ë©´ í•˜ë‹¨ì—ì„œ ì„ íƒí•©ë‹ˆë‹¤.</span>
      </div>
      <div class="status" id="setupHint"></div>
    </div>

    <!-- Chat -->
    <div class="panel hidden" id="chatPanel">
      <div class="chat" id="chat"></div>

      <div class="resultCard hidden" id="resultPanel">
        <div class="resultTop">
          <div class="big">ì´ì : <span id="scoreText" class="mono"></span>ì </div>
          <div class="badge" id="badge"></div>
        </div>
        <div class="small" style="margin-top:8px;">
          ì‘ì‹œì: <span id="who" class="mono"></span> Â· ì‘ì‹œì›”: <span id="whenMonth" class="mono"></span> Â· íƒ€ì…: <span id="whichType" class="mono"></span><br/>
          ì‹œì‘: <span id="started" class="mono"></span> Â· ì œì¶œ: <span id="finished" class="mono"></span> Â· ì†Œìš”: <span id="duration" class="mono"></span>ì´ˆ
        </div>

        <div class="review" id="review"></div>

        <div class="row">
          <button class="btn" id="retryBtn">ğŸ” ë‹¤ì‹œ ì‘ì‹œ</button>
          <button class="btn" id="backBtn">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        </div>

        <div class="status" id="saveStatus"></div>
      </div>
    </div>
  </div>

  <!-- Option bar (choices) -->
  <div class="optionBar hidden" id="optionBar">
    <div class="optionInner">
      <div class="optionHint">
        <div class="hintLeft">
          <button class="miniBtn" id="prevBtn" type="button">â¬…ï¸ ì´ì „</button>
          <span class="pill">ì§„í–‰: <b id="progressText">-</b></span>
          <span class="pill">ë¯¸ì‘ë‹µ: <b id="unansweredText">-</b></span>
        </div>
        <div class="hintRight">
          <span>ë³´ê¸°ë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ìŒ ë¬¸í•­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</span>
          <span class="pill">ì„ íƒë¨: <b id="selectedText">ì—†ìŒ</b></span>
        </div>
      </div>
      <div class="optionGrid">
      <button class="optionBtn" data-idx="0" id="opt0"></button>
      <button class="optionBtn" data-idx="1" id="opt1"></button>
      <button class="optionBtn" data-idx="2" id="opt2"></button>
      <button class="optionBtn" data-idx="3" id="opt3"></button>
      </div>
    </div>
  </div>

  <script>
/** =========================================================
 *  Google Apps Script Web App Endpoint
 *  ========================================================= */
const SUBMIT_ENDPOINT = "https://script.google.com/macros/s/AKfycbyOx6veFMa7hzfai9o7gMq6QUyLQd_kmtzBgvJ2JTrO_A1TPfrKaORaZ-fJZYwupus/exec";

/** ===== ì‹œí—˜ ì„¤ì • ===== */
const PASS_SCORE = 80;
const QUESTIONS_PER_TEST = 10;
const POINT_PER_QUESTION = 10;

/** =========================================================
 *  ë¬¸ì œì€í–‰ (A/B ê° 10ë¬¸í•­)
 *  ========================================================= */
const QUESTIONS_A = [
  { q: "Q1. ë‹¤ìŒ ì¤‘ ì¼ë°˜ì ì¸ í…ŒìŠ¤íŠ¸ ëª©ì ì— í•´ë‹¹í•˜ëŠ” ê²ƒì€?", options: ["A. ê²°í•¨ ì˜ˆë°©", "B. ê²°í•¨ ìˆ˜ì •", "C. ê²°í•¨ ì œê±°", "D. ì¥ì•  ì›ì¸ ë¶„ì„"], answer: 0 },
  { q: `Q2. íšŒì‚¬ëŠ” ì¼ì • ê´€ë¦¬ ì•±ì„ ê°œë°œí•˜ê³  ìˆë‹¤. ê°œë°œíŒ€ì€ ì•±ì˜ í•µì‹¬ ê¸°ëŠ¥ì¸ ì¼ì • ì¶”ê°€, ìˆ˜ì •, ì‚­ì œ ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì§‘ì¤‘ì ìœ¼ë¡œ ìˆ˜í–‰í–ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ë™ì¼í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ë°˜ë³µì ìœ¼ë¡œ ì‚¬ìš©í–ˆê³ , ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì¶”ê°€í•˜ì§€ ì•Šì•˜ë‹¤. ì•± ì¶œì‹œ í›„ ì‚¬ìš©ìê°€ ì¼ì •ì„ ì—¬ëŸ¬ ê°œ ë“±ë¡í•  ê²½ìš° ì•±ì´ ì¢…ë£Œë˜ëŠ” ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì—ˆë‹¤.
ë‹¤ìŒ ì¤‘ ì´ ìƒí™©ì„ ì„¤ëª…í•´ì£¼ëŠ” í…ŒìŠ¤íŒ… ì›ë¦¬ëŠ”?`, options: ["A. ê²°í•¨-ë¶€ì¬ëŠ” ì˜¤ë¥˜ì´ë‹¤", "B. ì™„ë²½í•œ í…ŒìŠ¤íŒ…ì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤", "C. í…ŒìŠ¤íŠ¸ íš¨ê³¼ëŠ” ì¤„ì–´ë“ ë‹¤", "D. í…ŒìŠ¤íŒ…ì€ ì •í™©ì— ì˜ì¡´ì ì´ë‹¤"], answer: 2 },
  { q: "Q3. ë‹¤ìŒ ì¤‘ ì „ì²´ íŒ€ ì ‘ê·¼ë²•ì— ëŒ€í•œ ì¥ì ìœ¼ë¡œ ì ì ˆí•œ ê²ƒì€?", options: ["A. ê°œë°œ ë¹„ìš©ì´ ì¤„ì–´ë“ ë‹¤", "B. íŒ€ ë‚´ ì˜ì‚¬ì†Œí†µê³¼ í˜‘ì—…ì´ ê°•í™”ëœë‹¤", "C. ì¶œì‹œ ì¼ì •ì„ ì§€í‚¬ í™•ë¥ ì´ ë†’ì•„ì§„ë‹¤", "D. ë…ë¦½ì ì¸ í…ŒìŠ¤í„°ê°€ í•„ìš” ì—†ë‹¤"], answer: 1 },
  { q: "Q4. ë‹¤ìŒ ì¤‘ í–‰ìœ„ì£¼ë„ê°œë°œ(BDD)ì— ëŒ€í•œ ì„¤ëª…ì´ ì•„ë‹Œ ê²ƒì€?", options: ["A. ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ëŒ€ ë™ì‘ì„ ê¸°ìˆ ì  ë°°ê²½ì´ ì ì€ ì´í•´ê´€ê³„ìë“¤ë„ ì´í•´í•  ìˆ˜ ìˆëŠ” ìì—°ì–´ë¡œ ì‘ì„±í•œë‹¤.", "D. ì‚¬ìš©ì ìŠ¤í† ë¦¬ì˜ ì¸ìˆ˜ ì¡°ê±´ì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ë„ì¶œí•˜ì—¬ ìˆ˜í–‰í•œë‹¤.", "C. ìì—°ì–´ ìš”êµ¬ì‚¬í•­ì€ ì¼ë°˜ì ìœ¼ë¡œ Given/When/Then ì˜ í˜•íƒœë¡œ ì‘ì„±í•œë‹¤.", "D. BDD ë°©ì‹ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ì‚¬ìš©ì, ê°œë°œì ë° í…ŒìŠ¤í„° ê°„ì˜ ì˜ì‚¬ ì†Œí†µì„ ì´‰ì§„í•œë‹¤."], answer: 1 },
  { q: "Q5. ì‹œí”„íŠ¸-ë ˆí”„íŠ¸ ì ‘ê·¼ë²•ì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ì ì ˆí•œ ê²ƒì€?", options: ["A. í…ŒìŠ¤íŒ…ì€ ì œí’ˆ ê°œë°œì´ ëë‚œ í›„ì— ìˆ˜í–‰í•œë‹¤.", "B. ë¹„ê¸°ëŠ¥ í…ŒìŠ¤íŒ…ì€ ì‹œìŠ¤í…œ ë ˆë²¨ ë˜ëŠ” ì¸ìˆ˜ í…ŒìŠ¤íŠ¸ ë ˆë²¨ì—ì„œ ìˆ˜í–‰í•œë‹¤.", "C. ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸° ì „ì— í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‘ì„±í•œë‹¤.", "D. ë¦¬ë·°ì— í…ŒìŠ¤í„°ê°€ ì°¸ì—¬í•˜ì§€ ì•Šì•„ë„ ëœë‹¤."], answer: 2 },
  { q: "Q6. ë‹¤ìŒ ì¤‘ ë¶„ê¸° ì»¤ë²„ë¦¬ì§€ì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ì ì ˆí•˜ì§€ ì•Šì€ ê²ƒì€?", options: ["A. ë¶„ê¸° í…ŒìŠ¤íŒ…ì˜ ì»¤ë²„ë¦¬ì§€ í•­ëª©ì€ ë¶„ê¸°ì´ë‹¤.", "B. ì»¤ë²„ë¦¬ì§€ëŠ” í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ê°€ ì‹¤í–‰í•œ ë¶„ê¸° ìˆ˜ë¥¼ ë¶„ê¸°ì˜ ì´ìˆ˜ë¡œ ë‚˜ëˆˆ ê°’ìœ¼ë¡œ ì¸¡ì •í•œë‹¤.", "C. 100% ë¶„ê¸° ì»¤ë²„ë¦¬ì§€ë¥¼ ë‹¬ì„±í•˜ë”ë¼ë„ êµ¬ë¬¸ ì»¤ë²„ë¦¬ì§€ëŠ” 100%ê°€ ì•„ë‹ ìˆ˜ë„ ìˆë‹¤.", "D. ë¶„ê¸° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ìœ¼ë¡œ ëª¨ë“  ê²°í•¨ì„ ë‹¤ ì°¾ì„ ìˆ˜ ìˆëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤."], answer: 2 },
  { q: `Q7. ì˜¨ë¼ì¸ ìƒì  ìš´ì˜ìì˜ ê´€ì ì—ì„œ ì‘ì„±ëœ ì‚¬ìš©ì ìŠ¤í† ë¦¬ì˜ ì¸ìˆ˜ ì¡°ê±´ì´ ë‹¤ìŒê³¼ ê°™ë‹¤:
- Given: ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ê³  í™ˆí˜ì´ì§€ì— ì ‘ì†í•œ ìƒí™©ì—ì„œ,
- When: â€œìƒí’ˆ ì¶”ê°€â€ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´,
- Then: â€œìƒí’ˆ ì…ë ¥â€ í˜ì´ì§€ê°€ ì¶œë ¥ë˜ê³ ,
- And: ì‚¬ìš©ìëŠ” ìƒˆ ìƒí’ˆì˜ ì´ë¦„ê³¼ ê°€ê²©ì„ ì…ë ¥í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
ì´ ì¸ìˆ˜ ì¡°ê±´ì€ ì–´ë–¤ í˜•ì‹ìœ¼ë¡œ ì‘ì„±ëœ ê²ƒì¸ê°€?`, options: ["A. ì‹œë‚˜ë¦¬ì˜¤ ì¤‘ì‹¬", "B. ê·œì¹™ ì¤‘ì‹¬", "C. ì œí’ˆ ì¤‘ì‹¬", "D. í”„ë¡œì„¸ìŠ¤ ì¤‘ì‹¬"], answer: 0 },
  { q: "Q8. ë‹¤ìŒ ì¤‘ í…ŒìŠ¤íŒ… ì‹œì‘ ì¡°ê±´ì˜ ì˜ˆë¡œ ì ì ˆí•œ ê²ƒì€?", options: ["A. í•´ê²°ë˜ì§€ ì•Šì€ ê²°í•¨ ìˆ˜", "B. ë¦¬ìŠ¤í¬ ì»¤ë²„ë¦¬ì§€ ìˆ˜ì¤€", "C. ì¸ë ¥, ë„êµ¬, í…ŒìŠ¤íŠ¸ ë°ì´í„° ë“± ìì›ì˜ ê°€ìš©ì„±", "D. ê³„íší•œ í…ŒìŠ¤íŠ¸ì˜ ì‹¤í–‰ìœ¨"], answer: 2 },
  { q: "Q9. ë‹¤ìŒ ì¤‘ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ì˜ ì •ì˜ë¡œ ì ì ˆí•œ ê²ƒì€?", options: ["A. ì‚¬ìš©ìì˜ ê²°ì œ ì‘ì—… ì„±ê³µë¥ ì€ 80% ì´ìƒì´ ë˜ì–´ì•¼ í•œë‹¤.", "B. êµ¬ë¬¸ ì»¤ë²„ë¦¬ì§€ 100%", "C. ê³„íšëœ ì¼ì • ëŒ€ë¹„ ì§„ì²™ìœ¨", "D. í…ŒìŠ¤íŠ¸ ëª¨ë¸ì„ ì‘ì„±í•˜ê¸° ìœ„í•œ í…ŒìŠ¤íŠ¸ ë² ì´ì‹œìŠ¤ì˜ ê°€ìš©ì„±"], answer: 3 },
  { q: "Q10. ìë™í™”ì˜ ì ì¬ì  ë¦¬ìŠ¤í¬ì— ëŒ€í•œ ë¦¬ìŠ¤í¬ ì™„í™” ì¡°ì¹˜ë¡œ ì ì ˆí•˜ì§€ ì•Šì€ ê²ƒì€?", options: ["A. ë„êµ¬ì˜ íš¨ê³¼ì— ëŒ€í•œ ë¹„í˜„ì‹¤ì ì¸ ê¸°ëŒ€ë¥¼ ê²½ê³„í•œë‹¤.", "B. ë„êµ¬ ë„ì…, ìš´ìš©ì— ëŒ€í•œ ìì›ì„ ì¶©ë¶„íˆ ê³ ë ¤í•œë‹¤.", "C. ê°œì„ í•´ì•¼ í•  ì‘ì—…ì— ë„ì…ë˜ëŠ” ë„êµ¬ì— ì „ì ìœ¼ë¡œ ì˜ì¡´í•œë‹¤.", "D. ê·œì œ ìš”ê±´ì´ë‚˜ ì•ˆì „ í‘œì¤€ì„ ì¤€ìˆ˜í•˜ëŠ”ì§€ ë„êµ¬ë¥¼ ì‚¬ì „ì— í‰ê°€í•œë‹¤."], answer: 2 }
];

// âœ… Bíƒ€ì… ë¬¸ì œ ë°ì´í„° (í˜„ì¬ëŠ” ë™ì¼ ì„¸íŠ¸ë¡œ êµ¬ì„± â€” í•„ìš” ì‹œ B ì „ìš© ë¬¸í•­ìœ¼ë¡œ êµì²´ ê°€ëŠ¥)
const QUESTIONS_B = [
  { q: "Q1. ë‹¤ìŒ ì¤‘ í…ŒìŠ¤íŒ… í”„ë¡œì„¸ìŠ¤ë¥¼ êµ¬ì„±í•˜ëŠ” ì¼ë°˜ì  í™œë™ì´ ì•„ë‹Œ ê²ƒì€?", options: ["A. í…ŒìŠ¤íŠ¸ ê³„íš", "B. í…ŒìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜", "C. í…ŒìŠ¤íŠ¸ ì„¤ê³„", "D. í…ŒìŠ¤íŠ¸ ëª¨ë‹ˆí„°ë§"], answer: 1 },
  { q: `Q2. ë‹¤ìŒ ì¤‘ í…ŒìŠ¤íŒ…ê³¼ ë””ë²„ê¹…ì˜ ì°¨ì´ì ì„ ê°€ì¥ ì˜ ì„¤ëª…í•œ ê²ƒì€?`, options: ["A. í…ŒìŠ¤íŒ…ì€ ìë™í™” ë„êµ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ, ë””ë²„ê¹…ì€ ìë™í™” ë„êµ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.", "B. í…ŒìŠ¤íŒ…ì€ ê°œë°œ ì´ˆê¸° ë‹¨ê³„ì—ì„œ, ë””ë²„ê¹…ì€ ê°œë°œ í›„ë°˜ ë‹¨ê³„ì—ì„œ ìˆ˜í–‰í•œë‹¤. ", "C. í…ŒìŠ¤íŒ…ì€ ê²°í•¨ì„ ì°¾ëŠ” í™œë™ì´ê³ , ë””ë²„ê¹…ì€ ê²°í•¨ì˜ ì›ì¸ì„ ë¶„ì„í•˜ê³  ìˆ˜ì •í•˜ëŠ” í™œë™ì´ë‹¤.", "D. í…ŒìŠ¤íŒ…ì€ ëª¨ë“  ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œ í”„ë¡œì„¸ìŠ¤ì— í•„ìˆ˜ì ì´ì§€ë§Œ, ë””ë²„ê¹…ì€ ì„ íƒì ì¸ í™œë™ì´ë‹¤."], answer: 2 },
  { q: "Q3. ë‹¤ìŒ ì¤‘ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë‹¨ê³„ì˜ ì‘ì—…ì‚°ì¶œë¬¼ì€?", options: ["A. ë¦¬ìŠ¤í¬ ì •ë³´", "B. í…ŒìŠ¤íŠ¸ ë¡œê·¸", "C. í…ŒìŠ¤íŠ¸ í™˜ê²½ ìš”êµ¬ì‚¬í•­", "D. í…ŒìŠ¤íŠ¸ ì»¨ë””ì…˜"], answer: 1 },
  { q: "Q4. í…ŒìŠ¤íŒ… ê´€ì ì—ì„œ ë°ë¸Œì˜µìŠ¤(DevOps)ì˜ ì´ì ìœ¼ë¡œ ì ì ˆí•˜ì§€ ì•Šì€ ê²ƒì€?", options: ["A. ë¹ ë¥´ê³  ì§€ì†ì ì¸ í”¼ë“œë°±ì„ ì œê³µí•  ìˆ˜ ìˆë‹¤.", "B. ìë™í™”ëœ í”„ë¡œì„¸ìŠ¤ê°€ ì´‰ì§„ëœë‹¤.", "C. ë¦¬ê·¸ë ˆì…˜ ë¦¬ìŠ¤í¬ê°€ ê°ì†Œí•œë‹¤.", "D. ìˆ˜ë™ í…ŒìŠ¤íŒ…ì˜ í•„ìš”ì„±ì´ ë†’ì•„ì§„ë‹¤."], answer: 3 },
  { q: `Q5. ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ì§•ì„ ê°–ëŠ” ë¦¬ë·° ìœ í˜•ì€? 
  - ì €ìê°€ ë¦¬ë”ê°€ ëœë‹¤. 
  - ê°œë³„ ë¦¬ë·°ë¥¼ ë°˜ë“œì‹œ í•´ì•¼ë§Œ í•˜ëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤. 
  - í”„ë¡œì íŠ¸ ì°¸ê°€ìë“¤ì—ê²Œ ì‘ì—… ì‚°ì¶œë¬¼ì— ëŒ€í•´ êµìœ¡í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©í•˜ê¸°ë„ í•œë‹¤.`, options: ["A. ì›Œí¬ì“°ë£¨", "B. ì¸ìŠ¤í™ì…˜", "C. ê¸°ìˆ  ë¦¬ë·°.", "D. í˜ì–´ ë¦¬ë·°"], answer: 0 },
  { q: "Q6. ë¹ ë¥´ê³  ì¦ì€ í”¼ë“œë°±ì˜ ì´ì ìœ¼ë¡œ ì ì ˆí•œ ê²ƒì€?", options: ["A. ì‚°ì¶œë¬¼ì— ë¬¸ì œê°€ ì—†ìŒì„ ì¦ëª…í•  ìˆ˜ ìˆë‹¤.", "B. ìš”êµ¬ì‚¬í•­ì— ëŒ€í•œ ì˜¤í•´ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.", "C. ìš”êµ¬ì‚¬í•­ì„ ìì£¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.", "D. ê²°í•¨ í•´ê²° ì‹œê°„ì´ ë¹¨ë¼ì§„ë‹¤."], answer: 1 },
  { q: `Q7. ë‹¤ìŒ ì¤‘ ê²½í—˜ê¸°ë°˜ í…ŒìŠ¤íŒ…ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜ í…ŒìŠ¤íŒ…ì„ ê°€ì¥ ì˜ ì„¤ëª…í•œ ê²ƒì€?`, options: ["A. ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ í™œìš©í•´ í…ŒìŠ¤íŠ¸ ì»¨ë””ì…˜ì„ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì„¤ê³„, êµ¬í˜„, ì‹¤í–‰í•œë‹¤.", "B. ì¼ë°˜ì ì¸ í•­ëª©ì„ í¬í•¨í•´ ìë™ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆëŠ” í•­ëª©ê¹Œì§€ ìµœëŒ€í•œ ë§ì€ í•­ëª©ì„ í¬í•¨ì‹œì¼œ ì»¤ë²„ë¦¬ì§€ë¥¼ ëŠ˜ë¦°ë‹¤.", "C. ë…ë¦½ì ìœ¼ë¡œ ì‘ì„±ëœ ì²´í¬ë¦¬ìŠ¤íŠ¸ëŠ” ì˜¤ëœ ê¸°ê°„ ìˆ˜ì • ì—†ì´ ì‚¬ìš©í•´ë„ ê·¸ íš¨ê³¼ë¥¼ ê¸°ëŒ€í•  ìˆ˜ ìˆë‹¤.", "D. í…ŒìŠ¤íŒ… ì»¤ë²„ë¦¬ì§€ë¥¼ ë¹ ë¥´ê²Œ ë‹¬ì„±í•˜ê¸° ìœ„í•´ í•˜ìœ„ ìˆ˜ì¤€ìœ¼ë¡œ ì‘ì„±í•˜ëŠ” ê²ƒì´ ë°”ëŒì§í•˜ë‹¤."], answer: 0 },
  { q: "Q8. ë‹¤ìŒ ì¤‘ í…ŒìŠ¤íŒ… ì‚¬ë¶„ë©´ ëª¨ë¸ì—ì„œ 1ì‚¬ë¶„ë©´ (â€œê¸°ìˆ  ì¸¡ë©´ ë° â€œíŒ€ ì§€ì›â€) ì— í•´ë‹¹í•˜ëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€?", options: ["A. ì‚¬ìš©ì„± í…ŒìŠ¤íŒ…", "B. ê¸°ëŠ¥ í…ŒìŠ¤íŒ…", "C. ì‚¬ìš©ì ì¸ìˆ˜ í…ŒìŠ¤íŒ…", "D. ë‹¨ìœ„ í†µí•© í…ŒìŠ¤íŒ…"], answer: 3 },
  { q: "Q9. ë‹¤ìŒ ì¤‘ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ì˜ ì •ì˜ë¡œ ì ì ˆí•œ ê²ƒì€?", options: ["A. ì‚¬ìš©ìì˜ ê²°ì œ ì‘ì—… ì„±ê³µë¥ ì€ 80% ì´ìƒì´ ë˜ì–´ì•¼ í•œë‹¤.", "B. í…ŒìŠ¤íŠ¸ ëª¨ë¸ì„ ì‘ì„±í•˜ê¸° ìœ„í•œ í…ŒìŠ¤íŠ¸ ë² ì´ì‹œìŠ¤ì˜ ê°€ìš©ì„± ", "C. ê³„íšëœ ì¼ì • ëŒ€ë¹„ ì§„ì²™ìœ¨", "D. êµ¬ë¬¸ ì»¤ë²„ë¦¬ì§€ 100%"], answer: 1 },
  { q: `Q10. íšŒì‚¬ëŠ” ë³µì¡í•œ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ëŠ” ê¸ˆìœµ ê±°ë˜ ì‹œìŠ¤í…œì„ ê°œë°œí•˜ê³  ìˆë‹¤. ì´ ì‹œìŠ¤í…œì€ ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ê±°ë˜ë¥¼ ìŠ¹ì¸í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ê°œë°œíŒ€ì€ ì‹œìŠ¤í…œì˜ ì„±ëŠ¥ì„ ì •í™•í•˜ê²Œ ì¸¡ì •í•˜ê³  ë³‘ëª© í˜„ìƒì„ íŒŒì•…í•˜ì—¬ ìµœì í™”í•˜ë ¤ê³  í•œë‹¤. 
  ì´ ìƒí™©ì— ê°€ì¥ ì ì ˆí•œ ìœ í˜•ì˜ í…ŒìŠ¤íŠ¸ ë„êµ¬ëŠ” ë¬´ì—‡ì¸ê°€?`, options: ["A. ì •ì  í…ŒìŠ¤íŒ… ë„êµ¬.", "B. ë¹„ê¸°ëŠ¥ í…ŒìŠ¤íŒ… ë„êµ¬", "C. ê´€ë¦¬ ë„êµ¬", "D. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ë„êµ¬"], answer: 1 }
];

const QUESTION_BANK = { A: QUESTIONS_A, B: QUESTIONS_B };


// ===== DOM =====
const $ = (id) => document.getElementById(id);

const setupPanel = $("setupPanel");
const chatPanel = $("chatPanel");
const optionBar = $("optionBar");

const nameInput = $("name");
const runMonthSelect = $("runMonth");
const startBtn = $("startBtn");
const setupHint = $("setupHint");

const chat = $("chat");

const prevBtn = $("prevBtn");

const progressText = $("progressText");
const unansweredText = $("unansweredText");

const selectedText = $("selectedText");
const optBtns = [
  $("opt0"), $("opt1"), $("opt2"), $("opt3")
];

const resultPanel = $("resultPanel");
const scoreText = $("scoreText");
const badge = $("badge");
const who = $("who");
const whenMonth = $("whenMonth");
const whichType = $("whichType");
const started = $("started");
const finished = $("finished");
const duration = $("duration");
const review = $("review");
const saveStatus = $("saveStatus");

const retryBtn = $("retryBtn");
const backBtn = $("backBtn");


/** ===== layout: keep chat readable (no overlap with fixed bars) ===== */

function updateLayoutVars(){
  const root = document.documentElement;
  const optionVisible = !optionBar.classList.contains("hidden");
  const optionH = optionVisible ? optionBar.getBoundingClientRect().height : 0;
  root.style.setProperty("--stackH", `${Math.max(optionH, 140)}px`);
}

// tiny debounce for resize
let __resizeTimer = null;
window.addEventListener("resize", () => {
  clearTimeout(__resizeTimer);
  __resizeTimer = setTimeout(updateLayoutVars, 50);
});

// ===== state =====
let __advancing = false; // prevent double taps during auto-advance

let startedAtISO = "";
let finishedAtISO = "";
let currentType = "A";
let runMonth = "";
let currentQuestions = [];
let currentIndex = 0;
let answers = []; // chosenIndex per question (null if not answered)

// ===== init months (2026-01 ~ 2026-12) =====
(function populate2026Months(){
  const year = 2026;
  for (let m=1; m<=12; m++){
    const mm = String(m).padStart(2, "0");
    const value = `${year}-${mm}`;
    const opt = document.createElement("option");
    opt.value = value;
    opt.textContent = value;
    runMonthSelect.appendChild(opt);
  }
  runMonthSelect.value = `${year}-01`;
})();

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function scrollToBottom(){
  requestAnimationFrame(() => window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" }));
}

function addBubble(who, text, qIndex = -1, kind = "msg"){
  const div = document.createElement("div");
  div.className = `bubble ${who}`;
  div.dataset.qindex = String(qIndex);
  div.dataset.kind = kind;
  div.innerHTML = `
    <div>${escapeHtml(text)}</div>
  `;
  chat.appendChild(div);
  scrollToBottom();
  return div;
}

// Remove chat bubbles that belong to questions after the given index
function pruneFutureChat(maxQIndex){
  const nodes = Array.from(chat.children);
  nodes.forEach(n => {
    const qi = Number(n?.dataset?.qindex ?? -1);
    if (!Number.isNaN(qi) && qi > maxQIndex) n.remove();
  });
}

function scrollToQuestion(qIndex){
  // Prefer the bot question bubble, otherwise any bubble of that question
  const qBubble = chat.querySelector(`.bubble[data-qindex="${qIndex}"][data-kind="question"]`)
    || chat.querySelector(`.bubble[data-qindex="${qIndex}"]`);
  if (qBubble && typeof qBubble.scrollIntoView === "function"){
    requestAnimationFrame(() => qBubble.scrollIntoView({ behavior:"smooth", block:"start" }));
  } else {
    scrollToBottom();
  }
}

function updateBars(){
  const total = currentQuestions.length;
  const answered = answers.filter(v => v !== null && v !== undefined).length;
  const unanswered = total - answered;

  if (progressText) progressText.textContent = `${currentIndex+1}/${total}`;
  if (unansweredText) unansweredText.textContent = `${unanswered}ê°œ`;

  if (prevBtn) prevBtn.disabled = currentIndex === 0;

  // option selection label
  const sel = answers[currentIndex];
  selectedText.textContent = (sel === null || sel === undefined) ? "ì—†ìŒ" : String.fromCharCode(97 + sel);
  updateLayoutVars();
}

// keep layout in sync
// (bars can change size with content / device)


function renderOptions(){
  const q = currentQuestions[currentIndex];

  optionBar.classList.remove("hidden");
  updateLayoutVars();

  optBtns.forEach((btn, idx) => {
    const prefix = String.fromCharCode(97 + idx); // a,b,c,d (ë¼ë²¨/ìƒíƒœìš©)

    // âœ… options ì‚¬ìš© + í™”ë©´ì—ì„œ a. ìë™ìœ¼ë¡œ ì•ˆ ë¶™ì„ (ë°ì´í„°ì— ì´ë¯¸ ë“¤ì–´ìˆìœ¼ë‹ˆê¹Œ)
    const optText = (q.options ?? q.choices ?? [])[idx] ?? "";
    btn.textContent = optText;

    btn.classList.toggle("selected", answers[currentIndex] === idx);

    btn.onclick = () => {
      if (__advancing) return;
      __advancing = true;

      // if user changed an earlier answer via "ì´ì „", clear future answers + chat
      for (let i = currentIndex + 1; i < answers.length; i++) answers[i] = null;
      pruneFutureChat(currentIndex);

      answers[currentIndex] = idx;

      // visual (hard reset to avoid "selected" leakage)
      optBtns.forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");

      // âœ… ì„ íƒ ë¼ë²¨ì€ a/b/c/d ê·¸ëŒ€ë¡œ ìœ ì§€
      selectedText.textContent = prefix;

      // âœ… ì±„íŒ…ì— ì°ëŠ” ì„ íƒ ë¬¸êµ¬ë„ options ì‚¬ìš© (a. í¬í•¨ëœ í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ì¶œë ¥ë¨)
      addBubble("me", `ì„ íƒ: ${optText}`, currentIndex, "answer");

      updateBars();

      // auto move next (or submit if last)
      const isLast = currentIndex >= currentQuestions.length - 1;
      setTimeout(async () => {
        try{
          if (isLast){
            await submitExam();
          } else {
            currentIndex++;
            renderCurrentQuestion();
          }
        } finally {
          __advancing = false;
        }
      }, 180);
    };
  });
}

function renderCurrentQuestion(){
  const q = currentQuestions[currentIndex];
  // âœ… ë°ì´í„°(q.q)ì— ì´ë¯¸ "Q1. " ë“¤ì–´ìˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ì¶œë ¥
  addBubble("bot", `${q.q}`, currentIndex, "question");
  renderOptions();
  updateBars();
}


function pickRandomType(){
  return Math.random() < 0.5 ? "A" : "B";
}

function startExam(){
  const nm = nameInput.value.trim();
  if (!nm){
    setupHint.textContent = "âš ï¸ ì‘ì‹œì ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
    return;
  }
  setupHint.textContent = "";

  runMonth = runMonthSelect.value;

  // âœ… ë¬¸ì œ íƒ€ì…ì€ ì‚¬ìš©ìê°€ ì„ íƒí•˜ì§€ ì•Šê³ , ì‹œí—˜ ì‹œì‘ ì‹œ ëœë¤ìœ¼ë¡œ ìë™ ë°°ì •
  currentType = pickRandomType();
  startedAtISO = new Date().toISOString();
  finishedAtISO = "";

  currentQuestions = QUESTION_BANK[currentType].slice(0, QUESTIONS_PER_TEST);
  answers = new Array(currentQuestions.length).fill(null);
  currentIndex = 0;

  setupPanel.classList.add("hidden");
  chatPanel.classList.remove("hidden");
    optionBar.classList.remove("hidden");
  updateLayoutVars();

  chat.innerHTML = "";
  resultPanel.classList.add("hidden");
  saveStatus.textContent = "";

  addBubble("bot",
    `ì•ˆë…•í•˜ì„¸ìš”, ${nm}ë‹˜!\nì‘ì‹œì›”: ${runMonth}\nì´ ${QUESTIONS_PER_TEST}ë¬¸í•­ì…ë‹ˆë‹¤.\në¬¸ì œëŠ” ì±„íŒ…ì— í‘œì‹œë˜ê³ , ë³´ê¸°ëŠ” í•˜ë‹¨ì—ì„œ ì„ íƒí•©ë‹ˆë‹¤.`
  , -1, "intro");

  renderCurrentQuestion();
}

function movePrev(){
  if (currentIndex === 0) return;
  currentIndex--;
  // When going back, invalidate later answers to avoid inconsistent state
  for (let i = currentIndex + 1; i < answers.length; i++) answers[i] = null;
  // remove any already-rendered future question bubbles so "ë‹¤ìŒ ë¬¸í•­"ì´ ì•ˆ ë³´ì´ê²Œ í•¨
  pruneFutureChat(currentIndex);
  // show the previous question options without re-adding duplicate question bubbles
  renderOptions();
  updateBars();
  scrollToQuestion(currentIndex);
}

function grade(){
  let correctCount = 0;

  const details = currentQuestions.map((q, idx) => {
    const chosen = answers[idx];
    const opts = q.options ?? q.choices ?? [];
    const correct = (chosen === q.answer);
    if (correct) correctCount++;

    return {
      no: idx+1,
      question: q.q,
      chosenIndex: chosen,
      chosenText: chosen === null ? "" : (opts[chosen] ?? ""),
      answerIndex: q.answer,
      answerText: opts[q.answer] ?? "",
      correct,
      // âœ… ê²°ê³¼ ìƒì„¸ ë¦¬ë·°ì—ì„œ ì „ì²´ ë³´ê¸° í…ìŠ¤íŠ¸ë¥¼ ì“°ê¸° ìœ„í•´ ê°™ì´ ë‚´ë ¤ì¤Œ
      options: opts
    };
  });

  const score = correctCount * POINT_PER_QUESTION;
  const passed = score >= PASS_SCORE;
  return { score, passed, correctCount, totalQuestions: currentQuestions.length, details };
}

function renderResult(result){
  const nm = nameInput.value.trim();
  const finishedAt = new Date(finishedAtISO);

  scoreText.textContent = String(result.score);
  badge.className = "badge " + (result.passed ? "pass" : "fail");
  badge.textContent = result.passed ? "PASS" : "FAIL";

  who.textContent = nm;
  whenMonth.textContent = runMonth;
  whichType.textContent = currentType;

  started.textContent = new Date(startedAtISO).toLocaleString("ko-KR");
  finished.textContent = finishedAt.toLocaleString("ko-KR");
  const dur = Math.round((finishedAt.getTime() - new Date(startedAtISO).getTime()) / 1000);
  duration.textContent = String(isNaN(dur) ? "" : dur);

  review.innerHTML = "";
  result.details.forEach(d => {
    const div = document.createElement("div");
    div.className = "revItem " + (d.correct ? "good" : "bad");
    const formatOpt = (s) => {
      if (s === null || s === undefined) return "";
      // optionsì— "a. ..." í˜•íƒœê°€ ìˆìœ¼ë©´ ê²°ê³¼ ë¦¬ë·°ì—ì„œëŠ” "A. ..."ë¡œ í‘œê¸°
      return String(s).replace(/^([a-d])\./i, (_, p1) => p1.toUpperCase() + ".");
    };

    const myAns = (d.chosenIndex === null || d.chosenIndex === undefined)
      ? `<span class="mono" style="color:var(--warn)">ë¯¸ì‘ë‹µ</span>`
      : `<span class="mono">${escapeHtml(formatOpt(d.options?.[d.chosenIndex] ?? d.chosenText ?? ""))}</span>`;

    const ansText = `<span class="mono">${escapeHtml(formatOpt(d.options?.[d.answerIndex] ?? d.answerText ?? ""))}</span>`;
    div.innerHTML = `
      <div class="revHead">
        <div style="font-weight:1000;">${escapeHtml(d.question)}</div>
        <div class="badge ${d.correct ? "pass" : "fail"}">${d.correct ? "ì •ë‹µ" : "ì˜¤ë‹µ"}</div>
      </div>
      <div class="small" style="margin-top:8px;">
        ë‚´ ì„ íƒ: ${myAns}<br/>
        ì •ë‹µ: ${ansText}
      </div>
    `;
    review.appendChild(div);
  });

  resultPanel.classList.remove("hidden");
  scrollToBottom();
}

async function saveToSheet(payload){
  // âœ… CORS/íŒŒì¼(file://) í™˜ê²½ì—ì„œë„ ìµœëŒ€í•œ ì €ì¥ë˜ê²Œ: 
  //  1) ì¼ë°˜ fetch(ì‘ë‹µ í™•ì¸ ê°€ëŠ¥) ì‹œë„
  //  2) ì‹¤íŒ¨í•˜ë©´ no-corsë¡œ ì¬ì‹œë„(ìš”ì²­ì€ ì „ì†¡ë˜ì§€ë§Œ ì‘ë‹µ í™•ì¸ì€ ë¶ˆê°€)
  saveStatus.textContent = "ğŸ’¾ ì‘ë‹µ ì €ì¥ ì¤‘...";
  const body = JSON.stringify(payload);

  // 1) ì •ìƒ CORS ëª¨ë“œ (í˜¸ìŠ¤íŒ…ëœ https í™˜ê²½ì—ì„œ ê¶Œì¥)
  try{
    const res = await fetch(SUBMIT_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" }, // âœ… preflight ì¤„ì´ê¸°
      body,
      mode: "cors",
      redirect: "follow"
    });

    let bodyText = "";
    try { bodyText = await res.text(); } catch(_){}

    saveStatus.textContent = res.ok
      ? "âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì €ì¥ ì™„ë£Œ"
      : `âš ï¸ ì €ì¥ ì‹¤íŒ¨(HTTP ${res.status}) ${bodyText ? " / " + bodyText : ""}`;

    return { ok: res.ok, status: res.status, text: bodyText };
  }catch(err){
    // 2) file:// ë¡œ ì§ì ‘ ì—´ì—ˆì„ ë•Œ 'Origin null' CORSë¡œ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ê°€ ë§ìŒ
    try{
      await fetch(SUBMIT_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type":"text/plain;charset=utf-8" },
        body,
        mode: "no-cors",     // âœ… ìš”ì²­ ì „ì†¡ ìš°ì„ 
        redirect: "follow"
      });
      saveStatus.textContent = "âœ… ì €ì¥ ìš”ì²­ì„ ì „ì†¡í–ˆì–´ìš”. (ë¸Œë¼ìš°ì €ê°€ ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ì–´ í™•ì¸ì€ ì‹œíŠ¸ì—ì„œ í•´ì£¼ì„¸ìš”)";
      return { ok: true, opaque: true };
    }catch(err2){
      saveStatus.textContent = `âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ${err2?.message || err2}`;
      return { ok:false, error:String(err2) };
    }
  }
}

async function submitExam(){
  finishedAtISO = new Date().toISOString();

  const nm = nameInput.value.trim();
  const result = grade();
  const dur = Math.round((new Date(finishedAtISO).getTime() - new Date(startedAtISO).getTime()) / 1000);

  const payload = {
    runMonth,
    exam_type: currentType,
    name: nm,
    startedAt: startedAtISO,
    finishedAt: finishedAtISO,
    durationSec: dur,
    score: result.score,
    passScore: PASS_SCORE,
    result: result.passed ? "PASS" : "FAIL",
    correctCount: result.correctCount,
    totalQuestions: result.totalQuestions,
    answers: result.details
  };

  addBubble("bot", "ì œì¶œ ì™„ë£Œ! ê²°ê³¼ë¥¼ í‘œì‹œí• ê²Œìš”.", -1, "submit");
  optionBar.classList.add("hidden");
  updateLayoutVars();

  renderResult(result);
  await saveToSheet(payload);
}

// ===== events =====
startBtn.addEventListener("click", startExam);
if (prevBtn) prevBtn.addEventListener("click", movePrev);

retryBtn.addEventListener("click", () => {
  // keep setup values
  setupPanel.classList.remove("hidden");
  chatPanel.classList.add("hidden");
  optionBar.classList.add("hidden");
  updateLayoutVars();
  chat.innerHTML = "";
  resultPanel.classList.add("hidden");
  saveStatus.textContent = "";
});

backBtn.addEventListener("click", () => {
  nameInput.value = "";
  runMonthSelect.value = "2026-01";

  setupPanel.classList.remove("hidden");
  chatPanel.classList.add("hidden");
  optionBar.classList.add("hidden");
  updateLayoutVars();
  chat.innerHTML = "";
  resultPanel.classList.add("hidden");
  saveStatus.textContent = "";
});
</script>
</body>
</html>
