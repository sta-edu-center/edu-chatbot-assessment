<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>êµìœ¡ ì´ìˆ˜ í‰ê°€ (ì±—ë´‡í˜•)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Malgun Gothic", sans-serif; margin:0; background:#f5f7fb; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .card { background:#fff; border-radius:16px; box-shadow: 0 8px 24px rgba(0,0,0,.08); overflow:hidden; }
    .head { padding:16px 18px; border-bottom:1px solid #eef1f6; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;}
    .title { font-weight:900; }
    .meta { font-size:12px; color:#6b7280; }
    .badge { font-size:12px; padding:4px 10px; border-radius:999px; background:#eef1f6; color:#111827; }
    .danger { background:#fee2e2; color:#991b1b; }
    .success { background:#dcfce7; color:#166534; }

    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#f3f4f6; font-size:12px; margin-top:8px; }
    .pill b { font-weight:900; }

    .chat { padding:16px 18px; min-height: 360px; background:linear-gradient(#ffffff, #fbfcff); }
    .bubble { max-width: 92%; padding:12px 14px; border-radius:14px; margin:10px 0; line-height:1.45; white-space:pre-wrap; }
    .bot { background:#eef2ff; border-top-left-radius:6px; }
    .user { background:#ecfeff; margin-left:auto; border-top-right-radius:6px; }

    /* ìš´ì˜ì›” í° ë°°ë„ˆ */
    .banner {
      max-width: 92%;
      padding: 16px 18px;
      border-radius: 16px;
      margin: 12px 0 4px;
      background: #111827;
      color: #fff;
      font-weight: 950;
      letter-spacing: .2px;
      line-height: 1.35;
      white-space:pre-wrap;
      font-size: 18px;
    }
    .banner .sub { font-weight: 650; opacity: .9; font-size: 12px; margin-top: 8px; }

    .actions { padding:12px 18px 18px; border-top:1px solid #eef1f6; background:#fff; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select { padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; }
    input { flex: 1; min-width: 200px; }

    .btn { padding:10px 12px; border:0; border-radius:10px; cursor:pointer; font-weight:800; }
    .btn.primary { background:#111827; color:#fff; }
    .btn.ghost { background:#eef1f6; color:#111827; }
    .btn.option { background:#f3f4f6; color:#111827; border:1px solid #e5e7eb; text-align:left; }
    .btn.option:hover { filter: brightness(0.98); }
    .btn.review { background:#2563eb; color:#fff; }
    .btn.review:disabled { opacity:.5; cursor:not-allowed; }
    .btn.admin { background:#0f172a; color:#fff; }

    
    /* í—¤ë” ìš°ì¸¡ ìƒë‹¨ ê´€ë¦¬ì ì•„ì´ì½˜ ë²„íŠ¼ (URLì— ?admin=true ì¼ ë•Œë§Œ ë…¸ì¶œ) */
    #adminBtn{
      width:32px; height:32px; border-radius:999px;
      border:none; background:transparent;
      font-size:18px; cursor:pointer;
      opacity:.6; display:none;
      margin-left:8px;
      transition: opacity .2s ease, background .2s ease;
    }
    #adminBtn:hover{ opacity:1; background: rgba(0,0,0,.05); }
.options { margin-top: 10px; display:grid; gap:10px; }
    .hint { font-size:12px; color:#6b7280; margin-top:10px; }
    .footer { padding: 12px 18px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; border-top:1px solid #eef1f6; }

    /* ê´€ë¦¬ì íŒ¨ë„ */
    .adminPanel { display:none; border-top:1px solid #eef1f6; padding:14px 18px; background:#fff; }
    .adminPanel.on { display:block; }
    .adminTitle { font-weight:950; margin-bottom:8px; }
    .small { font-size:12px; color:#6b7280; }
    .divider { height:1px; background:#eef1f6; margin:12px 0; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="head">
      <div>
        <div class="title">êµìœ¡ ì´ìˆ˜ í‰ê°€ (ì±—ë´‡í˜•)</div>
        <div class="meta">ê°ê´€ì‹ 10ë¬¸í•­ Â· ìë™ ì±„ì  Â· Pass/Fail Â· ì‘ë‹µ Google Sheets ìë™ ì €ì¥</div>
        <div class="pill">
          ìš´ì˜ ì›”: <b id="runMonthLabel">ë¯¸ì„¤ì •</b>
          <span class="meta">(ìš´ì˜ì ì„¤ì •)</span>
        </div>
      </div>
      <div class="meta">
        <span id="statusBadge" class="badge">ëŒ€ê¸°</span>
        <button id="adminBtn" title="ê´€ë¦¬ì ì„¤ì •" aria-label="ê´€ë¦¬ì ì„¤ì •">âš™ï¸</button>
      </div>
    </div>

    <div id="chat" class="chat"></div>

    <div class="actions">
      <div class="row">
        <input id="name" placeholder="ì´ë¦„ (í•„ìˆ˜)" />
        <input id="org" placeholder="ì†Œì† (ì„ íƒ)" />
        <button id="startBtn" class="btn primary">ì´ìˆ˜ í‰ê°€ ì‹œì‘</button>
        <button id="resetBtn" class="btn ghost" disabled>ë¦¬ì…‹</button>
        <button id="reviewBtn" class="btn review" disabled>ì •ë‹µ ë¦¬ë·° ë³´ê¸°</button>
</div>

      <div class="hint">
        Â· ë³´ê¸° ë²„íŠ¼ì„ í´ë¦­í•´ ë‹µë³€í•˜ì„¸ìš”. (ì •ë‹µ/ì˜¤ë‹µì€ ì§„í–‰ ì¤‘ í‘œì‹œí•˜ì§€ ì•ŠìŒ)<br/>
        Â· ë§ˆì§€ë§‰ì— Pass/Failê³¼ ì ìˆ˜ê°€ í‘œì‹œë˜ë©°, ì‘ë‹µì€ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.<br/>
        Â· ì¢…ë£Œ í›„ â€œì •ë‹µ ë¦¬ë·° ë³´ê¸°â€ë¡œ ì„ íƒ/ì •ë‹µì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>

      <div id="options" class="options"></div>
    </div>

    <!-- ê´€ë¦¬ì ì„¤ì • íŒ¨ë„ -->
    <div id="adminPanel" class="adminPanel">
      <div class="adminTitle">ê´€ë¦¬ì ì„¤ì •</div>
      <div class="row">
        <input id="pinInput" type="password" placeholder="ê´€ë¦¬ì PIN" style="max-width:260px;" />
        <button id="unlockBtn" class="btn primary">ì ê¸ˆ í•´ì œ</button>
        <button id="lockBtn" class="btn ghost" disabled>ì ê¸ˆ</button>
      </div>

      <div class="divider"></div>

      <div id="adminFields" style="display:none;">
        <div class="row">
          <label class="meta" style="min-width:78px;">ìš´ì˜ ì›”</label>
          <select id="monthSelect"></select>
          <button id="saveMonthBtn" class="btn primary">ì €ì¥</button>
          <button id="clearMonthBtn" class="btn ghost">ì´ˆê¸°í™”</button>
        </div>
        <div class="small" style="margin-top:8px;">
          Â· ìš´ì˜ ì›”ì€ ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤(í˜„ì¥ ìš´ì˜ PCì—ì„œ 1íšŒ ì„¤ì • ê¶Œì¥).<br/>
          Â· ì„¤ì • í›„ êµìœ¡ìƒì€ â€œìš´ì˜ ì›”â€ì„ ì‹œì‘ í™”ë©´ì—ì„œ í¬ê²Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="meta">ê¸°ì¤€ ì ìˆ˜: <span id="passScoreView">80</span>ì  ì´ìƒ Pass</div>
      <div class="row">
        <label class="meta">Pass ê¸°ì¤€</label>
        <select id="passScore">
          <option value="70">70</option>
          <option value="80" selected>80</option>
          <option value="90">90</option>
        </select>
      </div>
    </div>

  </div>
</div>

<script>
  // =========================
  // âœ… ë°˜ë“œì‹œ ì„¤ì •í•  ê²ƒ 2ê°œ
  // =========================
  const SUBMIT_ENDPOINT = "https://script.google.com/macros/s/AKfycby3Zks4PTgNbFAw1ghS9IqsekBnTbad5dGcJQXiBfvRzI80v1xa5LX-dWp0UCHxYaMd/exec";
  const ADMIN_PIN = "Welcome123"; // âœ… ì—¬ê¸°ë§Œ ë„ˆê°€ ì“°ëŠ” PINìœ¼ë¡œ

  // =========================
  // âœ… ë¬¸ì œ + ì •ë‹µ (A set)
  // 1 a, 2 c, 3 b, 4 b, 5 c, 6 c, 7 a, 8 c, 9 d, 10 c
  // answer ì¸ë±ìŠ¤: a=0, b=1, c=2, d=3
  // =========================
  const QUESTIONS = [
    { q: "Q1. ë‹¤ìŒ ì¤‘ ì¼ë°˜ì ì¸ í…ŒìŠ¤íŠ¸ ëª©ì ì— í•´ë‹¹í•˜ëŠ” ê²ƒì€?",
      options: ["a. ê²°í•¨ ì˜ˆë°©","b. ê²°í•¨ ìˆ˜ì •","c. ê²°í•¨ ì œê±°","d. ì¥ì•  ì›ì¸ ë¶„ì„"], answer: 0 },
    { q: "Q2. íšŒì‚¬ëŠ” ì¼ì • ê´€ë¦¬ ì•±ì„ ê°œë°œí•˜ê³  ìˆë‹¤. ê°œë°œíŒ€ì€ ì•±ì˜ í•µì‹¬ ê¸°ëŠ¥ì¸ ì¼ì • ì¶”ê°€, ìˆ˜ì •, ì‚­ì œ ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì§‘ì¤‘ì ìœ¼ë¡œ ìˆ˜í–‰í–ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ë™ì¼í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ë°˜ë³µì ìœ¼ë¡œ ì‚¬ìš©í–ˆê³ , ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì¶”ê°€í•˜ì§€ ì•Šì•˜ë‹¤. ì•± ì¶œì‹œ í›„ ì‚¬ìš©ìê°€ ì¼ì •ì„ ì—¬ëŸ¬ ê°œ ë“±ë¡í•  ê²½ìš° ì•±ì´ ì¢…ë£Œë˜ëŠ” ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì—ˆë‹¤.\n\në‹¤ìŒ ì¤‘ ì´ ìƒí™©ì„ ì„¤ëª…í•´ì£¼ëŠ” í…ŒìŠ¤íŒ… ì›ë¦¬ëŠ”?",
      options: ["a. ê²°í•¨-ë¶€ì¬ëŠ” ì˜¤ë¥˜ì´ë‹¤","b. ì™„ë²½í•œ í…ŒìŠ¤íŒ…ì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤","c. í…ŒìŠ¤íŠ¸ íš¨ê³¼ëŠ” ì¤„ì–´ë“ ë‹¤","d. í…ŒìŠ¤íŒ…ì€ ì •í™©ì— ì˜ì¡´ì ì´ë‹¤"], answer: 2 },
    { q: "Q3. ë‹¤ìŒ ì¤‘ ì „ì²´ íŒ€ ì ‘ê·¼ë²•ì— ëŒ€í•œ ì¥ì ìœ¼ë¡œ ì ì ˆí•œ ê²ƒì€?",
      options: ["a. ê°œë°œ ë¹„ìš©ì´ ì¤„ì–´ë“ ë‹¤","b. íŒ€ ë‚´ ì˜ì‚¬ì†Œí†µê³¼ í˜‘ì—…ì´ ê°•í™”ëœë‹¤","c. ì¶œì‹œ ì¼ì •ì„ ì§€í‚¬ í™•ë¥ ì´ ë†’ì•„ì§„ë‹¤","d. ë…ë¦½ì ì¸ í…ŒìŠ¤í„°ê°€ í•„ìš” ì—†ë‹¤"], answer: 1 },
    { q: "Q4. ë‹¤ìŒ ì¤‘ í–‰ìœ„ì£¼ë„ê°œë°œ(BDD)ì— ëŒ€í•œ ì„¤ëª…ì´ ì•„ë‹Œ ê²ƒì€?",
      options: [
        "a. ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ëŒ€ ë™ì‘ì„ ê¸°ìˆ ì  ë°°ê²½ì´ ì ì€ ì´í•´ê´€ê³„ìë“¤ë„ ì´í•´í•  ìˆ˜ ìˆëŠ” ìì—°ì–´ë¡œ ì‘ì„±í•œë‹¤.",
        "b. ì‚¬ìš©ì ìŠ¤í† ë¦¬ì˜ ì¸ìˆ˜ ì¡°ê±´ì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ë„ì¶œí•˜ì—¬ ìˆ˜í–‰í•œë‹¤.",
        "c. ìì—°ì–´ ìš”êµ¬ì‚¬í•­ì€ ì¼ë°˜ì ìœ¼ë¡œ Given/When/Then ì˜ í˜•íƒœë¡œ ì‘ì„±í•œë‹¤.",
        "d. BDD ë°©ì‹ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ì‚¬ìš©ì, ê°œë°œì ë° í…ŒìŠ¤í„° ê°„ì˜ ì˜ì‚¬ ì†Œí†µì„ ì´‰ì§„í•œë‹¤."
      ], answer: 1 },
    { q: "Q5. ì‹œí”„íŠ¸-ë ˆí”„íŠ¸ ì ‘ê·¼ë²•ì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ì ì ˆí•œ ê²ƒì€?",
      options: [
        "a. í…ŒìŠ¤íŒ…ì€ ì œí’ˆ ê°œë°œì´ ëë‚œ í›„ì— ìˆ˜í–‰í•œë‹¤.",
        "b. ë¹„ê¸°ëŠ¥ í…ŒìŠ¤íŒ…ì€ ì‹œìŠ¤í…œ ë ˆë²¨ ë˜ëŠ” ì¸ìˆ˜ í…ŒìŠ¤íŠ¸ ë ˆë²¨ì—ì„œ ìˆ˜í–‰í•œë‹¤.",
        "c. ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸° ì „ì— í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‘ì„±í•œë‹¤.",
        "d. ë¦¬ë·°ì— í…ŒìŠ¤í„°ê°€ ì°¸ì—¬í•˜ì§€ ì•Šì•„ë„ ëœë‹¤."
      ], answer: 2 },
    { q: "Q6. ë‹¤ìŒ ì¤‘ ë¶„ê¸° ì»¤ë²„ë¦¬ì§€ì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ì ì ˆí•˜ì§€ ì•Šì€ ê²ƒì€?",
      options: [
        "a. ë¶„ê¸° í…ŒìŠ¤íŒ…ì˜ ì»¤ë²„ë¦¬ì§€ í•­ëª©ì€ ë¶„ê¸°ì´ë‹¤.",
        "b. ì»¤ë²„ë¦¬ì§€ëŠ” í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ê°€ ì‹¤í–‰í•œ ë¶„ê¸° ìˆ˜ë¥¼ ë¶„ê¸°ì˜ ì´ìˆ˜ë¡œ ë‚˜ëˆˆ ê°’ìœ¼ë¡œ ì¸¡ì •í•œë‹¤.",
        "c. 100% ë¶„ê¸° ì»¤ë²„ë¦¬ì§€ë¥¼ ë‹¬ì„±í•˜ë”ë¼ë„ êµ¬ë¬¸ ì»¤ë²„ë¦¬ì§€ëŠ” 100%ê°€ ì•„ë‹ ìˆ˜ë„ ìˆë‹¤.",
        "d. ë¶„ê¸° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ìœ¼ë¡œ ëª¨ë“  ê²°í•¨ì„ ë‹¤ ì°¾ì„ ìˆ˜ ìˆëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤."
      ], answer: 2 },
    { q: "Q7. Given/When/Then/And ì¸ìˆ˜ ì¡°ê±´ì€ ì–´ë–¤ í˜•ì‹ìœ¼ë¡œ ì‘ì„±ëœ ê²ƒì¸ê°€?",
      options: ["a. ì‹œë‚˜ë¦¬ì˜¤ ì¤‘ì‹¬","b. ê·œì¹™ ì¤‘ì‹¬","c. ì œí’ˆ ì¤‘ì‹¬","d. í”„ë¡œì„¸ìŠ¤ ì¤‘ì‹¬"], answer: 0 },
    { q: "Q8. ë‹¤ìŒ ì¤‘ í…ŒìŠ¤íŒ… ì‹œì‘ ì¡°ê±´ì˜ ì˜ˆë¡œ ì ì ˆí•œ ê²ƒì€?",
      options: ["a. í•´ê²°ë˜ì§€ ì•Šì€ ê²°í•¨ ìˆ˜","b. ë¦¬ìŠ¤í¬ ì»¤ë²„ë¦¬ì§€ ìˆ˜ì¤€","c. ì¸ë ¥, ë„êµ¬, í…ŒìŠ¤íŠ¸ ë°ì´í„° ë“± ìì›ì˜ ê°€ìš©ì„±","d. ê³„íší•œ í…ŒìŠ¤íŠ¸ì˜ ì‹¤í–‰ìœ¨"], answer: 2 },
    { q: "Q9. ë‹¤ìŒ ì¤‘ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ì˜ ì •ì˜ë¡œ ì ì ˆí•œ ê²ƒì€?",
      options: ["a. ì‚¬ìš©ìì˜ ê²°ì œ ì‘ì—… ì„±ê³µë¥ ì€ 80% ì´ìƒì´ ë˜ì–´ì•¼ í•œë‹¤.","b. êµ¬ë¬¸ ì»¤ë²„ë¦¬ì§€ 100%","c. ê³„íšëœ ì¼ì • ëŒ€ë¹„ ì§„ì²™ìœ¨","d. í…ŒìŠ¤íŠ¸ ëª¨ë¸ì„ ì‘ì„±í•˜ê¸° ìœ„í•œ í…ŒìŠ¤íŠ¸ ë² ì´ì‹œìŠ¤ì˜ ê°€ìš©ì„±"], answer: 3 },
    { q: "Q10. ìë™í™”ì˜ ì ì¬ì  ë¦¬ìŠ¤í¬ì— ëŒ€í•œ ë¦¬ìŠ¤í¬ ì™„í™” ì¡°ì¹˜ë¡œ ì ì ˆí•˜ì§€ ì•Šì€ ê²ƒì€?",
      options: ["a. ë„êµ¬ì˜ íš¨ê³¼ì— ëŒ€í•œ ë¹„í˜„ì‹¤ì ì¸ ê¸°ëŒ€ë¥¼ ê²½ê³„í•œë‹¤.","b. ë„êµ¬ ë„ì…, ìš´ìš©ì— ëŒ€í•œ ìì›ì„ ì¶©ë¶„íˆ ê³ ë ¤í•œë‹¤.","c. ê°œì„ í•´ì•¼ í•  ì‘ì—…ì— ë„ì…ë˜ëŠ” ë„êµ¬ì— ì „ì ìœ¼ë¡œ ì˜ì¡´í•œë‹¤.","d. ê·œì œ ìš”ê±´ì´ë‚˜ ì•ˆì „ í‘œì¤€ì„ ì¤€ìˆ˜í•˜ëŠ”ì§€ ë„êµ¬ë¥¼ ì‚¬ì „ì— í‰ê°€í•œë‹¤."], answer: 2 },
  ];

  // ====== refs ======
  const chat = document.getElementById('chat');
  const optionsBox = document.getElementById('options');
  const startBtn = document.getElementById('startBtn');
  const resetBtn = document.getElementById('resetBtn');
  const reviewBtn = document.getElementById('reviewBtn');
  const statusBadge = document.getElementById('statusBadge');
  const passScoreSel = document.getElementById('passScore');
  const passScoreView = document.getElementById('passScoreView');
  const runMonthLabel = document.getElementById('runMonthLabel');

  const adminBtn = document.getElementById('adminBtn');

  // URL íŒŒë¼ë¯¸í„°ì— admin=trueê°€ ìˆì„ ë•Œë§Œ ê´€ë¦¬ì ì•„ì´ì½˜ ë…¸ì¶œ
  const params = new URLSearchParams(window.location.search);
  const isAdminParam = params.get('admin') === 'true';
  if (isAdminParam) adminBtn.style.display = 'inline-flex';
  const adminPanel = document.getElementById('adminPanel');
  const pinInput = document.getElementById('pinInput');
  const unlockBtn = document.getElementById('unlockBtn');
  const lockBtn = document.getElementById('lockBtn');
  const adminFields = document.getElementById('adminFields');
  const monthSelect = document.getElementById('monthSelect');
  const saveMonthBtn = document.getElementById('saveMonthBtn');
  const clearMonthBtn = document.getElementById('clearMonthBtn');

  // ====== state ======
  let idx = -1, score = 0, answers = [];
  let startedAt = null, finishedAt = null;
  let reviewShown = false;
  let adminUnlocked = false;

  // ====== helpers ======
  function setStatus(text, kind="") {
    statusBadge.textContent = text;
    statusBadge.className = "badge" + (kind ? " " + kind : "");
  }
  function addBubble(text, who="bot") {
    const div = document.createElement('div');
    div.className = `bubble ${who}`;
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
  function addBannerRunMonth(runMonth) {
    const div = document.createElement('div');
    div.className = "banner";
    div.innerHTML = `ìš´ì˜ ì›”: ${runMonth}\n<div class="sub">ì‘ì‹œ ì „ ìš´ì˜ ì›”ì„ í™•ì¸í•˜ì„¸ìš”.</div>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
  function clearOptions() { optionsBox.innerHTML = ""; }
  function showOptions(qObj) {
    clearOptions();
    qObj.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.className = "btn option";
      btn.textContent = opt;
      btn.onclick = () => choose(i);
      optionsBox.appendChild(btn);
    });
  }

  // ====== run month (12ê°œì›”: ì´ë²ˆë‹¬~+11) ======
  const RUN_MONTH_KEY = "RUN_MONTH";
  function getRunMonth() { return localStorage.getItem(RUN_MONTH_KEY) || ""; }
  function setRunMonth(v) { localStorage.setItem(RUN_MONTH_KEY, v); }
  function clearRunMonth() { localStorage.removeItem(RUN_MONTH_KEY); }

  function pad2(n){ return String(n).padStart(2, "0"); }
  function formatYYYYMM(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }

  function buildMonthOptions12() {
    const now = new Date();
    const base = new Date(now.getFullYear(), now.getMonth(), 1);
    const months = [];
    for (let i=0; i<12; i++) {
      const d = new Date(base.getFullYear(), base.getMonth() + i, 1);
      months.push(formatYYYYMM(d));
    }
    return months;
  }

  function refreshRunMonthLabel() {
    const v = getRunMonth();
    runMonthLabel.textContent = v ? v : "ë¯¸ì„¤ì •";
  }

  function populateMonthDropdown() {
    const months = buildMonthOptions12();
    monthSelect.innerHTML = "";
    months.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      monthSelect.appendChild(opt);
    });

    const current = getRunMonth();
    if (current && months.includes(current)) monthSelect.value = current;
  }

  // ====== admin UI ======
  adminBtn.addEventListener("click", () => {
    adminPanel.classList.toggle("on");
    populateMonthDropdown();
  });

  function lockAdmin() {
    adminUnlocked = false;
    adminFields.style.display = "none";
    lockBtn.disabled = true;
    pinInput.value = "";
  }

  unlockBtn.addEventListener("click", () => {
    if (pinInput.value === ADMIN_PIN) {
      adminUnlocked = true;
      adminFields.style.display = "block";
      lockBtn.disabled = false;
      addBubble("âœ… ê´€ë¦¬ì ì„¤ì •ì´ ì ê¸ˆ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ìš´ì˜ ì›”ì„ ì„ íƒ í›„ ì €ì¥í•˜ì„¸ìš”.", "bot");
    } else {
      alert("PINì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  });

  lockBtn.addEventListener("click", () => {
    lockAdmin();
    addBubble("ğŸ”’ ê´€ë¦¬ì ì„¤ì •ì´ ì ê²¼ìŠµë‹ˆë‹¤.", "bot");
  });

  saveMonthBtn.addEventListener("click", () => {
    if (!adminUnlocked) { alert("ë¨¼ì € PINìœ¼ë¡œ ì ê¸ˆ í•´ì œí•˜ì„¸ìš”."); return; }
    const v = monthSelect.value;
    setRunMonth(v);
    refreshRunMonthLabel();
    addBubble(`ğŸ“Œ ìš´ì˜ ì›”ì´ '${v}'ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, "bot");
  });

  clearMonthBtn.addEventListener("click", () => {
    if (!adminUnlocked) { alert("ë¨¼ì € PINìœ¼ë¡œ ì ê¸ˆ í•´ì œí•˜ì„¸ìš”."); return; }
    clearRunMonth();
    refreshRunMonthLabel();
    populateMonthDropdown();
    addBubble("ğŸ“Œ ìš´ì˜ ì›” ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.", "bot");
  });

  // ====== pass ê¸°ì¤€ ======
  passScoreSel.addEventListener('change', () => {
    passScoreView.textContent = passScoreSel.value;
  });

  // ====== submit (Sheets) ======
  async function submitToSheets(payload) {
    if (!SUBMIT_ENDPOINT || SUBMIT_ENDPOINT.includes("ì—¬ê¸°ì—_")) {
      addBubble("âš ï¸ ê´€ë¦¬ì ì„¤ì • í•„ìš”: ì‘ë‹µ ì €ì¥ URL(SUBMIT_ENDPOINT)ì´ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "bot");
      return { ok: false, error: "ENDPOINT_NOT_SET" };
    }
    try {
      const res = await fetch(SUBMIT_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      const json = await res.json().catch(() => ({}));
      return { ok: res.ok && json.ok === true, ...json };
    } catch (e) {
      return { ok: false, error: String(e) };
    }
  }

  // ====== exam flow ======
  function start() {
    const name = document.getElementById('name').value.trim();
    if (!name) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    const rm = getRunMonth();
    if (!rm) {
      alert("ìš´ì˜ ì›”ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nê´€ë¦¬ì ì„¤ì •ì—ì„œ ìš´ì˜ ì›”ì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    startedAt = new Date();
    idx = 0; score = 0; answers = [];
    finishedAt = null; reviewShown = false;

    chat.innerHTML = "";
    addBubble("ì•ˆë…•í•˜ì„¸ìš” ğŸ‘‹\nì§€ê¸ˆë¶€í„° êµìœ¡ ì´ìˆ˜ í‰ê°€ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\nì´ 10ë¬¸í•­ì´ë©°, ë³´ê¸° ë²„íŠ¼ì„ í´ë¦­í•´ ë‹µë³€í•˜ì„¸ìš”.", "bot");
    addBannerRunMonth(rm);
    addBubble("ì¤€ë¹„ê°€ ë˜ì…¨ë‹¤ë©´ 1ë²ˆ ë¬¸ì œë¥¼ ì‹œì‘í• ê²Œìš”.", "bot");

    setStatus("ì§„í–‰ì¤‘", "");
    startBtn.disabled = true;
    resetBtn.disabled = false;
    reviewBtn.disabled = true;

    renderQuestion();
  }

  function renderQuestion() {
    const qObj = QUESTIONS[idx];
    addBubble(qObj.q, "bot");
    showOptions(qObj);
  }

  function choose(selectedIndex) {
    const qObj = QUESTIONS[idx];
    const label = ["a","b","c","d"][selectedIndex] ?? String(selectedIndex + 1);
    addBubble(`ì„ íƒ: ${label}`, "user");

    const correct = (selectedIndex === qObj.answer);
    if (correct) score += 10;

    answers.push({ qNo: idx + 1, selectedIndex, selectedLabel: label, correct });

    idx++;
    clearOptions();

    if (idx < QUESTIONS.length) {
      addBubble("í™•ì¸í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™í• ê²Œìš” ğŸ‘‡", "bot");
      renderQuestion();
    } else {
      finish();
    }
  }

  function buildReviewLines() {
    const lines = [];
    lines.push("ğŸ“Œ ì •ë‹µ ë¦¬ë·° (ì„ íƒ / ì •ë‹µ / ê²°ê³¼)");
    lines.push(`ìš´ì˜ ì›”: ${getRunMonth()}`);
    lines.push("");

    for (let i=0; i<QUESTIONS.length; i++) {
      const q = QUESTIONS[i];
      const a = answers.find(x => x.qNo === i+1);
      const selectedLabel = a ? a.selectedLabel : "-";
      const correctLabel = ["a","b","c","d"][q.answer];
      const ox = a ? (a.correct ? "O" : "X") : "-";

      lines.push(`Q${i+1}. ${ox}`);
      lines.push(`- ì„ íƒ: ${selectedLabel}`);
      lines.push(`- ì •ë‹µ: ${correctLabel}`);
      lines.push(`- ì •ë‹µ ë³´ê¸°: ${q.options[q.answer]}`);
      lines.push("");
    }
    return lines.join("\n");
  }

  reviewBtn.addEventListener("click", () => {
    if (reviewShown) return;
    reviewShown = true;
    addBubble(buildReviewLines(), "bot");
  });

  async function finish() {
    finishedAt = new Date();
  const passed = score >= PASS_SCORE;

  setBadge(passed ? "ok" : "no", passed ? "Pass" : "Fail");

  // ê²°ê³¼ ë§í’ì„  ìƒì„±
  const bubble = addMsg(
    "bot",
    `ì´ì : ${score}ì \nê²°ê³¼: ${passed ? "PASS" : "FAIL"}\n(ê¸°ì¤€: ${PASS_SCORE}ì  ì´ìƒ Pass)`
  );

  // â­ í•µì‹¬: Pass / Failì— ë”°ë¼ class ë¶€ì—¬
  bubble.classList.add("result");
  bubble.classList.add(passed ? "pass" : "fail");

  showReview();
}

    setStatus(resultLabel, pass ? "success" : "danger");
    addBubble("ëª¨ë“  ë¬¸í•­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ âœ…", "bot");
    addBubble(`ì´ì : ${score}ì \nê²°ê³¼: ${resultLabel}\n(ê¸°ì¤€: ${passScore}ì  ì´ìƒ Pass)`, "bot");

    addBubble("ì‘ë‹µì„ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤â€¦", "bot");

    const payload = {
      runMonth: getRunMonth(),
      name: document.getElementById('name').value.trim(),
      org: document.getElementById('org').value.trim(),
      startedAt: startedAt ? startedAt.toISOString() : "",
      finishedAt: finishedAt ? finishedAt.toISOString() : "",
      score,
      passScore,
      result: pass ? "PASS" : "FAIL",
      answers
    };

    const saved = await submitToSheets(payload);
    if (saved.ok) {
      addBubble("ì €ì¥ ì™„ë£Œ! ì œì¶œì´ ì •ìƒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ™Œ", "bot");
    } else {
      addBubble("âš ï¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\në„¤íŠ¸ì›Œí¬ ë˜ëŠ” ê´€ë¦¬ì ì„¤ì •(Apps Script ë°°í¬/ê¶Œí•œ/URL)ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "bot");
      console.log("Save failed:", saved);
    }

    reviewBtn.disabled = false;
    addBubble("ì›í•˜ì‹œë©´ ì•„ë˜ ë²„íŠ¼ì—ì„œ â€˜ì •ë‹µ ë¦¬ë·°â€™ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.", "bot");
  }

  function resetAll() {
    idx = -1; score = 0; answers = [];
    startedAt = null; finishedAt = null;
    reviewShown = false;

    chat.innerHTML = "";
    clearOptions();
    setStatus("ëŒ€ê¸°", "");
    startBtn.disabled = false;
    resetBtn.disabled = true;
    reviewBtn.disabled = true;

    addBubble("ë¦¬ì…‹ ì™„ë£Œ. ì´ë¦„ì„ ì…ë ¥í•˜ê³  â€˜ì´ìˆ˜ í‰ê°€ ì‹œì‘â€™ì„ ëˆ„ë¥´ì„¸ìš”.", "bot");
  }

  startBtn.addEventListener('click', start);
  resetBtn.addEventListener('click', resetAll);

  // ====== init ======
  refreshRunMonthLabel();
  populateMonthDropdown();
  lockAdmin();

  addBubble(
    "ìš´ì˜ ì•ˆë‚´:\n- ì‹œì‘ ì „ â€˜ê´€ë¦¬ì ì„¤ì •â€™ì—ì„œ ìš´ì˜ ì›”ì„ ì„ íƒí•´ ì €ì¥í•´ì£¼ì„¸ìš”.\n- êµìœ¡ìƒì€ ì‹œì‘ í™”ë©´ì—ì„œ ìš´ì˜ ì›”ì„ í¬ê²Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "bot"
  );
</script>
</body>
</html>
