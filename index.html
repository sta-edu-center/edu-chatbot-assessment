<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>STA êµìœ¡ì„¼í„° | SW Testing Foundation ì´ìˆ˜ í‰ê°€</title>
  <style>

    :root{
      /* ---------- layout (updated responsive) ---------- */
      --stackH: 240px;               /* optionBar + bottomBar combined (JS updates) */
      --safeBottom: env(safe-area-inset-bottom, 0px);

      /* Light theme */
      --bg1:#f7f9ff;
      --bg2:#eef3ff;
      --card:#ffffff;
      --line:rgba(15,23,42,.12);
      --text:#0f172a;
      --muted:#475569;

      --bot:#f1f5ff;
      --me:#2563eb;
      --meText:#ffffff;

      --good:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;

      --shadow: 0 14px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      background:linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 70%);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    .wrap{
      max-width:760px;
      margin:0 auto;
      padding:14px 12px calc(var(--stackH) + 28px);
    }
    .topbar{
      position:sticky; top:0; z-index:30;
      padding:12px 0 10px;
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(247,249,255,.92) 0%, rgba(247,249,255,.70) 65%, rgba(247,249,255,0) 100%);
    }
    .title{margin:0;font-size:clamp(15px, 2.2vw, 18px);font-weight:900;letter-spacing:-0.01em}
    .subtitle{margin:4px 0 0;color:var(--muted);font-size:clamp(12px, 1.8vw, 13px);line-height:1.35}

    .panel{
      background:rgba(255,255,255,.88);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow:var(--shadow);
      margin-top:10px;
    }

    .grid{
      display:grid; gap:10px;
      grid-template-columns: 1fr;
    }
    @media(min-width:560px){
      .grid{grid-template-columns: 1fr 1fr;}
    }

    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.16);
      background:#ffffff;
      color:var(--text);
      outline:none;
      box-shadow: 0 1px 0 rgba(15,23,42,.02) inset;
      font-size:14px;
    }
    input::placeholder{color:rgba(15,23,42,.35)}
    input:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .btn{
      border:1px solid rgba(15,23,42,.14);
      background:rgba(15,23,42,.04);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      font-size:14px;
      line-height:1;
      min-height:44px;
      touch-action:manipulation;
    }
    .btn.primary{
      background:rgba(37,99,235,.10);
      border-color:rgba(37,99,235,.35);
      color:#0b2a77;
    }
    .btn.primary:hover{background:rgba(37,99,235,.14);border-color:rgba(37,99,235,.45)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px;line-height:1.5}
    .status{color:var(--muted);font-size:12px;margin-top:10px}

    /* Chat area */
    .chat{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubble{
      max-width:min(92%, 640px);
      padding:12px 12px;
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
      white-space:pre-wrap;
      word-break:break-word;
      overflow-wrap:anywhere;
      line-height:1.55;
      font-size:clamp(14px, 2.1vw, 15px);
      letter-spacing:-0.01em;
    }
    .bot{
      align-self:flex-start;
      background:var(--bot);
      border-top-left-radius:10px;
    }
    .me{
      align-self:flex-end;
      background:var(--me);
      color:var(--meText);
      border-color:rgba(37,99,235,.40);
      border-top-right-radius:10px;
    }
    .meta{
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .me .meta{color:rgba(255,255,255,.85)}

    /* Option bar (answers) */
    .optionBar{
      position:fixed;
      left:0; right:0;
      bottom:0; /* JS will offset via transform if needed */
      padding:12px 12px calc(12px + var(--safeBottom));
      background:rgba(255,255,255,.94);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(15,23,42,.08);
      z-index:25;
    }
    .optionInner{
      max-width:760px;
      margin:0 auto;
      display:grid;
      gap:10px;
    }
    .optionHint{
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .optionGrid{
      display:grid;
      gap:10px;
      grid-template-columns:1fr;
    }
    @media(min-width:700px){
      .optionGrid{grid-template-columns:1fr 1fr;}
    }
    .optionBtn{
      width:100%;
      text-align:left;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid rgba(37,99,235,.18);
      background:#ffffff;
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      box-shadow: 0 8px 16px rgba(15,23,42,.05);
      user-select:none;
      min-height:48px;
      font-size:14px;
      line-height:1.35;
      touch-action:manipulation;
    }
    .optionBtn:hover{border-color:rgba(37,99,235,.40); background:rgba(37,99,235,.04)}
    .optionBtn.selected{
      border-color:rgba(37,99,235,.70);
      background:rgba(37,99,235,.08);
    }

    /* Bottom action bar (nav + submit) */
    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + var(--safeBottom));
      background:linear-gradient(180deg, rgba(247,249,255,0) 0%, rgba(247,249,255,.84) 30%, rgba(247,249,255,.96) 100%);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(15,23,42,.08);
      z-index:26;
    }
    .bottomInner{
      max-width:760px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .progress{
      color:var(--muted);
      font-size:12px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#ffffff;
      color:var(--muted);
      font-size:12px;
      user-select:none;
      line-height:1.2;
    }

    /* Result */
    .resultCard{
      background:#ffffff;
      border:1px solid rgba(15,23,42,.12);
      border-radius:18px;
      padding:14px;
      margin-top:10px;
      box-shadow:var(--shadow);
    }
    .resultTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .big{font-size:20px;font-weight:1000}
    .badge{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      font-weight:1000;
      font-size:12px;
      background:#fff;
    }
    .badge.pass{background:rgba(22,163,74,.10);border-color:rgba(22,163,74,.30);color:var(--good)}
    .badge.fail{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.30);color:var(--bad)}
    .review{margin-top:12px;display:grid;gap:10px}
    .revItem{
      border-radius:16px;
      border:1px solid rgba(15,23,42,.12);
      padding:12px;
      background:#ffffff;
    }
    .revItem.good{border-color:rgba(22,163,74,.28);background:rgba(22,163,74,.04)}
    .revItem.bad{border-color:rgba(239,68,68,.28);background:rgba(239,68,68,.04)}
    .revHead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start}
    .small{font-size:12px;color:var(--muted);line-height:1.55}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .hidden{display:none !important}

    /* small phones */
    @media(max-width:380px){
      .panel{padding:12px}
      .bubble{max-width:96%; padding:10px 10px}
      .btn{padding:11px 12px}
      .optionBtn{padding:12px 12px}
    }

  
/* ===== Chat bubbles: responsive compact (v3) ===== */
.chat{
  gap:8px;
}
.bubble{
  max-width: min(86%, 560px);
  padding: 10px 11px;
  line-height: 1.45;
  font-size: 14px;
  border-radius: 16px;
}
.bubble.bot{
  max-width: min(88%, 520px);
  padding: 9px 10px;
}
.meta{
  font-size: 10px;
  margin-bottom: 4px;
}
@media (max-width: 420px){
  .chat{ gap:7px; }
  .bubble{
    max-width: 84%;
    padding: 9px 10px;
    font-size: 13px;
    line-height: 1.4;
  }
  .bubble.bot{ max-width: 86%; }
  .meta{
    font-size: 9.5px;
    margin-bottom: 3px;
  }
}
@media (max-width: 360px){
  .bubble{
    max-width: 82%;
    padding: 8px 9px;
    font-size: 12.5px;
  }
}

</style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h1 class="title">STA êµìœ¡ì„¼í„° | SW Testing Foundation ì´ìˆ˜ í‰ê°€</h1>
      <div class="subtitle">ì´ 10ë¬¸í•­. 80ì  ì´ìƒ Pass <br> ê²°ê³¼ëŠ” ìë™ìœ¼ë¡œ STAêµìœ¡ì„¼í„° DBì— ì €ì¥ë©ë‹ˆë‹¤. (ì €ì¥ ë  ë•Œê¹Œì§€ ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)</div>
    </div>

    <!-- Setup -->
    <div class="panel" id="setupPanel">
      <div class="grid">
        <div>
          <label>ì‘ì‹œì ì´ë¦„</label>
          <input id="name" placeholder="ì˜ˆ) í™ê¸¸ë™ / ì‚¬ë²ˆ ë“±" />
        </div>
        <div>
          <label>ì‘ì‹œ ì›”</label>
          <select id="runMonth"></select>
        </div>
        <div>
          <label>ë¬¸ì œ íƒ€ì…</label>
          <select id="type">
            <option value="A">A íƒ€ì…</option>
            <option value="B">B íƒ€ì…</option>
          </select>
        </div>
        <div>
          <label>Pass ê¸°ì¤€</label>
          <input value="80ì  ì´ìƒ" disabled />
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="startBtn">ğŸš€ ì‹œí—˜ ì‹œì‘</button>
        <span class="hint">â€» ë¬¸ì œëŠ” ì±„íŒ…ì— í‘œì‹œë˜ê³ , ë³´ê¸°ëŠ” í™”ë©´ í•˜ë‹¨ì—ì„œ ì„ íƒí•©ë‹ˆë‹¤.</span>
      </div>
      <div class="status" id="setupHint"></div>
    </div>

    <!-- Chat -->
    <div class="panel hidden" id="chatPanel">
      <div class="chat" id="chat"></div>

      <div class="resultCard hidden" id="resultPanel">
        <div class="resultTop">
          <div class="big">ì´ì : <span id="scoreText" class="mono"></span>ì </div>
          <div class="badge" id="badge"></div>
        </div>
        <div class="small" style="margin-top:8px;">
          ì‘ì‹œì: <span id="who" class="mono"></span> Â· ì‘ì‹œì›”: <span id="whenMonth" class="mono"></span> Â· íƒ€ì…: <span id="whichType" class="mono"></span><br/>
          ì‹œì‘: <span id="started" class="mono"></span> Â· ì œì¶œ: <span id="finished" class="mono"></span> Â· ì†Œìš”: <span id="duration" class="mono"></span>ì´ˆ
        </div>

        <div class="review" id="review"></div>

        <div class="row">
          <button class="btn" id="retryBtn">ğŸ” ë‹¤ì‹œ ì‘ì‹œ</button>
          <button class="btn" id="backBtn">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        </div>

        <div class="status" id="saveStatus"></div>
      </div>
    </div>
  </div>

  <!-- Option bar (choices) -->
  <div class="optionBar hidden" id="optionBar">
    <div class="optionInner">
      <div class="optionHint">
        <span>ë³´ê¸°ë¥¼ ì„ íƒí•˜ë©´ ì±„íŒ…ì— ì„ íƒ ë‚´ìš©ì´ ê¸°ë¡ë©ë‹ˆë‹¤.</span>
        <span class="pill">ì„ íƒë¨: <b id="selectedText">ì—†ìŒ</b></span>
      </div>
      <div class="optionGrid">
      <button class="optionBtn" data-idx="0" id="opt0"></button>
      <button class="optionBtn" data-idx="1" id="opt1"></button>
      <button class="optionBtn" data-idx="2" id="opt2"></button>
      <button class="optionBtn" data-idx="3" id="opt3"></button>
      </div>
    </div>
  </div>

  <!-- Bottom nav bar -->
  <div class="bottomBar hidden" id="bottomBar">
    <div class="bottomInner">
      <div class="progress">
        <span class="pill">ì§„í–‰: <b id="progressText"></b></span>
        <span class="pill">ë¯¸ì‘ë‹µ: <b id="unansweredText"></b></span>
      </div>
      <div style="display:flex;gap:10px;">
        <button class="btn" id="prevBtn">â¬…ï¸ ì´ì „</button>
        <button class="btn primary" id="nextBtn">ë‹¤ìŒ â¡ï¸</button>
        <button class="btn primary hidden" id="submitBtn">ì œì¶œ âœ…</button>
      </div>
    </div>
  </div>

<script>
/** =========================================================
 *  Google Apps Script Web App Endpoint
 *  ========================================================= */
const SUBMIT_ENDPOINT = "https://script.google.com/macros/s/AKfycbzkXD776guuU-jG_xaV7bV05wUNIWlPcPEx7J1djpkfD4yCj0dohKMacyi9igCel8DE/exec";

/** ===== ì‹œí—˜ ì„¤ì • ===== */
const PASS_SCORE = 80;
const QUESTIONS_PER_TEST = 10;
const POINT_PER_QUESTION = 10;

/** =========================================================
 *  ë¬¸ì œì€í–‰ (A/B ê° 10ë¬¸í•­)
 *  ========================================================= */
const QUESTION_BANK = {
  A: [
    { q: "ë‹¤ìŒ ì¤‘ ì¼ë°˜ì ì¸ í…ŒìŠ¤íŠ¸ ëª©ì ì— í•´ë‹¹í•˜ëŠ” ê²ƒì€?", choices: ["ê²°í•¨ ì˜ˆë°©", "ê²°í•¨ ìˆ˜ì •", "ê²°í•¨ ì œê±°", "ì¥ì•  ì›ì¸ ë¶„ì„"], answer: 0 },
    { q: "íšŒì‚¬ëŠ” ì¼ì • ê´€ë¦¬ ì•±ì„ ê°œë°œí•˜ê³  ìˆë‹¤. ê°œë°œíŒ€ì€ ì•±ì˜ í•µì‹¬ ê¸°ëŠ¥ì¸ ì¼ì • ì¶”ê°€, ìˆ˜ì •, ì‚­ì œ ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì§‘ì¤‘ì ìœ¼ë¡œ ìˆ˜í–‰í–ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ë™ì¼í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ë°˜ë³µì ìœ¼ë¡œ ì‚¬ìš©í–ˆê³ , ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì¶”ê°€í•˜ì§€ ì•Šì•˜ë‹¤. ì•± ì¶œì‹œ í›„ ì‚¬ìš©ìê°€ ì¼ì •ì„ ì—¬ëŸ¬ ê°œ ë“±ë¡í•  ê²½ìš° ì•±ì´ ì¢…ë£Œë˜ëŠ” ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì—ˆë‹¤.\në‹¤ìŒ ì¤‘ ì´ ìƒí™©ì„ ì„¤ëª…í•´ì£¼ëŠ” í…ŒìŠ¤íŒ… ì›ë¦¬ëŠ”?", choices: ["ê²°í•¨-ë¶€ì¬ëŠ” ì˜¤ë¥˜ì´ë‹¤", "ì™„ë²½í•œ í…ŒìŠ¤íŒ…ì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤", "í…ŒìŠ¤íŠ¸ íš¨ê³¼ëŠ” ì¤„ì–´ë“ ë‹¤", "í…ŒìŠ¤íŒ…ì€ ì •í™©ì— ì˜ì¡´ì ì´ë‹¤"], answer: 2 },
    { q: "ë‹¤ìŒ ì¤‘ ì „ì²´ íŒ€ ì ‘ê·¼ë²•ì— ëŒ€í•œ ì¥ì ìœ¼ë¡œ ì ì ˆí•œ ê²ƒì€?", choices: ["ê°œë°œ ë¹„ìš©ì´ ì¤„ì–´ë“ ë‹¤", "íŒ€ ë‚´ ì˜ì‚¬ì†Œí†µê³¼ í˜‘ì—…ì´ ê°•í™”ëœë‹¤", "ì¶œì‹œ ì¼ì •ì„ ì§€í‚¬ í™•ë¥ ì´ ë†’ì•„ì§„ë‹¤", "ë…ë¦½ì ì¸ í…ŒìŠ¤í„°ê°€ í•„ìš” ì—†ë‹¤"], answer: 1 },
    { q: "ë‹¤ìŒ ì¤‘ í–‰ìœ„ì£¼ë„ê°œë°œ(BDD)ì— ëŒ€í•œ ì„¤ëª…ì´ ì•„ë‹Œ ê²ƒì€?", choices: ["ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ëŒ€ ë™ì‘ì„ ê¸°ìˆ ì  ë°°ê²½ì´ ì ì€ ì´í•´ê´€ê³„ìë“¤ë„ ì´í•´í•  ìˆ˜ ìˆëŠ” ìì—°ì–´ë¡œ ì‘ì„±í•œë‹¤.", "ì‚¬ìš©ì ìŠ¤í† ë¦¬ì˜ ì¸ìˆ˜ ì¡°ê±´ì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ë„ì¶œí•˜ì—¬ ìˆ˜í–‰í•œë‹¤.", "ìì—°ì–´ ìš”êµ¬ì‚¬í•­ì€ ì¼ë°˜ì ìœ¼ë¡œ Given/When/Then ì˜ í˜•íƒœë¡œ ì‘ì„±í•œë‹¤.", "BDD ë°©ì‹ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ì‚¬ìš©ì, ê°œë°œì ë° í…ŒìŠ¤í„° ê°„ì˜ ì˜ì‚¬ ì†Œí†µì„ ì´‰ì§„í•œë‹¤."], answer: 1 },
    { q: "ì‹œí”„íŠ¸-ë ˆí”„íŠ¸ ì ‘ê·¼ë²•ì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ì ì ˆí•œ ê²ƒì€?", choices: ["í…ŒìŠ¤íŒ…ì€ ì œí’ˆ ê°œë°œì´ ëë‚œ í›„ì— ìˆ˜í–‰í•œë‹¤.", "ë¹„ê¸°ëŠ¥ í…ŒìŠ¤íŒ…ì€ ì‹œìŠ¤í…œ ë ˆë²¨ ë˜ëŠ” ì¸ìˆ˜ í…ŒìŠ¤íŠ¸ ë ˆë²¨ì—ì„œ ìˆ˜í–‰í•œë‹¤.", "ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸° ì „ì— í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‘ì„±í•œë‹¤.", "ë¦¬ë·°ì— í…ŒìŠ¤í„°ê°€ ì°¸ì—¬í•˜ì§€ ì•Šì•„ë„ ëœë‹¤."], answer: 2 },
    { q: "ë‹¤ìŒ ì¤‘ ë¶„ê¸° ì»¤ë²„ë¦¬ì§€ì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ì ì ˆí•˜ì§€ ì•Šì€ ê²ƒì€?", choices: ["ë¶„ê¸° í…ŒìŠ¤íŒ…ì˜ ì»¤ë²„ë¦¬ì§€ í•­ëª©ì€ ë¶„ê¸°ì´ë‹¤.", "ì»¤ë²„ë¦¬ì§€ëŠ” í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ê°€ ì‹¤í–‰í•œ ë¶„ê¸° ìˆ˜ë¥¼ ë¶„ê¸°ì˜ ì´ìˆ˜ë¡œ ë‚˜ëˆˆ ê°’ìœ¼ë¡œ ì¸¡ì •í•œë‹¤.", "100% ë¶„ê¸° ì»¤ë²„ë¦¬ì§€ë¥¼ ë‹¬ì„±í•˜ë”ë¼ë„ êµ¬ë¬¸ ì»¤ë²„ë¦¬ì§€ëŠ” 100%ê°€ ì•„ë‹ ìˆ˜ë„ ìˆë‹¤.", "ë¶„ê¸° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ìœ¼ë¡œ ëª¨ë“  ê²°í•¨ì„ ë‹¤ ì°¾ì„ ìˆ˜ ìˆëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤."], answer: 2 },
    { q: "ì˜¨ë¼ì¸ ìƒì  ìš´ì˜ìì˜ ê´€ì ì—ì„œ ì‘ì„±ëœ ì‚¬ìš©ì ìŠ¤í† ë¦¬ì˜ ì¸ìˆ˜ ì¡°ê±´ì´ ë‹¤ìŒê³¼ ê°™ë‹¤:\nGiven: ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ê³  í™ˆí˜ì´ì§€ì— ì ‘ì†í•œ ìƒí™©ì—ì„œ,\nWhen: â€œìƒí’ˆ ì¶”ê°€â€ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´,\nThen: â€œìƒí’ˆ ì…ë ¥â€ í˜ì´ì§€ê°€ ì¶œë ¥ë˜ê³ ,\nAnd: ì‚¬ìš©ìëŠ” ìƒˆ ìƒí’ˆì˜ ì´ë¦„ê³¼ ê°€ê²©ì„ ì…ë ¥í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.\nì´ ì¸ìˆ˜ ì¡°ê±´ì€ ì–´ë–¤ í˜•ì‹ìœ¼ë¡œ ì‘ì„±ëœ ê²ƒì¸ê°€?", choices: ["ì‹œë‚˜ë¦¬ì˜¤ ì¤‘ì‹¬", "ê·œì¹™ ì¤‘ì‹¬", "ì œí’ˆ ì¤‘ì‹¬", "í”„ë¡œì„¸ìŠ¤ ì¤‘ì‹¬"], answer: 0 },
    { q: "ë‹¤ìŒ ì¤‘ í…ŒìŠ¤íŒ… ì‹œì‘ ì¡°ê±´ì˜ ì˜ˆë¡œ ì ì ˆí•œ ê²ƒì€?", choices: ["í•´ê²°ë˜ì§€ ì•Šì€ ê²°í•¨ ìˆ˜", "ë¦¬ìŠ¤í¬ ì»¤ë²„ë¦¬ì§€ ìˆ˜ì¤€", "ì¸ë ¥, ë„êµ¬, í…ŒìŠ¤íŠ¸ ë°ì´í„° ë“± ìì›ì˜ ê°€ìš©ì„±", "ê³„íší•œ í…ŒìŠ¤íŠ¸ì˜ ì‹¤í–‰ìœ¨"], answer: 2 },
    { q: "ë‹¤ìŒ ì¤‘ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ì˜ ì •ì˜ë¡œ ì ì ˆí•œ ê²ƒì€?", choices: ["ì‚¬ìš©ìì˜ ê²°ì œ ì‘ì—… ì„±ê³µë¥ ì€ 80% ì´ìƒì´ ë˜ì–´ì•¼ í•œë‹¤.", "êµ¬ë¬¸ ì»¤ë²„ë¦¬ì§€ 100%", "ê³„íšëœ ì¼ì • ëŒ€ë¹„ ì§„ì²™ìœ¨", "í…ŒìŠ¤íŠ¸ ëª¨ë¸ì„ ì‘ì„±í•˜ê¸° ìœ„í•œ í…ŒìŠ¤íŠ¸ ë² ì´ì‹œìŠ¤ì˜ ê°€ìš©ì„±"], answer: 3 },
    { q: "ìë™í™”ì˜ ì ì¬ì  ë¦¬ìŠ¤í¬ì— ëŒ€í•œ ë¦¬ìŠ¤í¬ ì™„í™” ì¡°ì¹˜ë¡œ ì ì ˆí•˜ì§€ ì•Šì€ ê²ƒì€?", choices: ["ë„êµ¬ì˜ íš¨ê³¼ì— ëŒ€í•œ ë¹„í˜„ì‹¤ì ì¸ ê¸°ëŒ€ë¥¼ ê²½ê³„í•œë‹¤.", "ë„êµ¬ ë„ì…, ìš´ìš©ì— ëŒ€í•œ ìì›ì„ ì¶©ë¶„íˆ ê³ ë ¤í•œë‹¤.", "ê°œì„ í•´ì•¼ í•  ì‘ì—…ì— ë„ì…ë˜ëŠ” ë„êµ¬ì— ì „ì ìœ¼ë¡œ ì˜ì¡´í•œë‹¤.", "ê·œì œ ìš”ê±´ì´ë‚˜ ì•ˆì „ í‘œì¤€ì„ ì¤€ìˆ˜í•˜ëŠ”ì§€ ë„êµ¬ë¥¼ ì‚¬ì „ì— í‰ê°€í•œë‹¤."], answer: 2 },
  ],
  B: [
    { q: "B-1. í…ŒìŠ¤íŠ¸ ê³„íšì„œì— í¬í•¨ë  ê°€ëŠ¥ì„±ì´ ê°€ì¥ ë†’ì€ í•­ëª©ì€?", choices: ["í…ŒìŠ¤íŠ¸ ë²”ìœ„/ì „ëµ/ì¼ì •/ìì›", "ê°œë°œì ì—°ë´‰", "íšŒì‚¬ ì£¼ê°€", "ê°œì¸ ì·¨ë¯¸"], answer: 0 },
    { q: "B-2. ì •ì  í…ŒìŠ¤íŠ¸(Static Testing)ì— í•´ë‹¹í•˜ëŠ” ê²ƒì€?", choices: ["ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰", "ì½”ë“œ ë¦¬ë·°/ì •ì  ë¶„ì„", "ë¶€í•˜ í…ŒìŠ¤íŠ¸", "ì¹¨íˆ¬ í…ŒìŠ¤íŠ¸"], answer: 1 },
    { q: "B-3. ìƒíƒœ ì „ì´ í…ŒìŠ¤íŠ¸(State Transition Testing)ê°€ íŠ¹íˆ ì í•©í•œ ëŒ€ìƒì€?", choices: ["ìƒíƒœì™€ ì „ì´ê°€ ìˆëŠ” ì‹œìŠ¤í…œ", "ë‹¨ìˆœ ê³„ì‚°ê¸°", "ì •ì  ì›¹í˜ì´ì§€", "ì´ë¯¸ì§€ í¸ì§‘ê¸° UI"], answer: 0 },
    { q: "B-4. ë¹„ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ì˜ ì˜ˆë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?", choices: ["ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­ ì¶©ì¡± ì—¬ë¶€", "ì„±ëŠ¥/ë³´ì•ˆ/ì‚¬ìš©ì„± ê²€ì¦", "ë‹¨ìœ„ í…ŒìŠ¤íŠ¸", "ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ì¦ê°€"], answer: 1 },
    { q: "B-5. í…ŒìŠ¤íŠ¸ ìë™í™”ì˜ ì£¼ìš” ë¦¬ìŠ¤í¬ë¡œ í”í•œ ê²ƒì€?", choices: ["ì´ˆê¸° êµ¬ì¶•/ìœ ì§€ë³´ìˆ˜ ë¹„ìš© ì¦ê°€", "í…ŒìŠ¤í„°ê°€ ë” ë¹¨ë¼ì§", "ê²°í•¨ì´ ì‚¬ë¼ì§", "ìš”êµ¬ì‚¬í•­ì´ ê³ ì •ë¨"], answer: 0 },
    { q: "B-6. ê²°í•¨ ì‹¬ê°ë„(Severity)ê°€ ì˜ë¯¸í•˜ëŠ” ê²ƒì€?", choices: ["ìˆ˜ì •ì˜ ê¸´ê¸‰ë„", "ì˜í–¥/ì†ìƒ ì •ë„", "ë‹´ë‹¹ì ìˆ˜", "ë°œê²¬ ì‹œê°„"], answer: 1 },
    { q: "B-7. ìš”êµ¬ì‚¬í•­ ì¶”ì ì„±(Traceability)ì˜ ëª©ì ì€?", choices: ["ìš”êµ¬ì‚¬í•­ ì‚­ì œ", "ìš”êµ¬ì‚¬í•­-í…ŒìŠ¤íŠ¸-ê²°í•¨ ì—°ê²°ë¡œ ì»¤ë²„ë¦¬ì§€/ì˜í–¥ ë¶„ì„", "í…ŒìŠ¤íŠ¸ë¥¼ ìƒëµ", "ì½”ë”© ì†ë„ í–¥ìƒ"], answer: 1 },
    { q: "B-8. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„ê°€ ì¤‘ìš”í•œ ì´ìœ ë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?", choices: ["UIë¥¼ ì˜ˆì˜ê²Œ í•˜ê¸° ìœ„í•´", "í˜„ì‹¤ì  ì‹œë‚˜ë¦¬ì˜¤/ê²½ê³„/ì˜ˆì™¸ë¥¼ ì¬í˜„í•˜ê¸° ìœ„í•´", "ë°°í¬ë¥¼ ë¹ ë¥´ê²Œ í•˜ê¸° ìœ„í•´", "ì½”ë“œ ìŠ¤íƒ€ì¼ì„ ë§ì¶”ê¸° ìœ„í•´"], answer: 1 },
    { q: "B-9. ê²°í•¨ ë¦¬í¬íŠ¸ì— í¬í•¨ë˜ë©´ ì¢‹ì€ ì •ë³´ëŠ”?", choices: ["ì¬í˜„ ì ˆì°¨/í™˜ê²½/ì‹¤ì œ ê²°ê³¼/ê¸°ëŒ€ ê²°ê³¼", "ë‹´ë‹¹ì ë³„ëª…", "íšŒì‚¬ ìŠ¬ë¡œê±´", "ê°œë°œ ì–¸ì–´ ì„ í˜¸"], answer: 0 },
    { q: "B-10. í…ŒìŠ¤íŠ¸ ì¢…ë£Œ(Exit Criteria) ì˜ˆì‹œë¡œ ì ì ˆí•œ ê²ƒì€?", choices: ["í…ŒìŠ¤í„°ê°€ í”¼ê³¤í•  ë•Œ", "ì¹˜ëª… ê²°í•¨ 0ê±´ + ê³„íšëœ í…ŒìŠ¤íŠ¸ 95% ì™„ë£Œ", "ì½”ë“œ ë¼ì¸ ìˆ˜ ì¦ê°€", "íšŒì˜ íšŸìˆ˜ ê°ì†Œ"], answer: 1 },
  ]
};

// ===== DOM =====
const $ = (id) => document.getElementById(id);

const setupPanel = $("setupPanel");
const chatPanel = $("chatPanel");
const bottomBar = $("bottomBar");
const optionBar = $("optionBar");

const nameInput = $("name");
const runMonthSelect = $("runMonth");
const typeSelect = $("type");
const startBtn = $("startBtn");
const setupHint = $("setupHint");

const chat = $("chat");

const prevBtn = $("prevBtn");
const nextBtn = $("nextBtn");
const submitBtn = $("submitBtn");

const progressText = $("progressText");
const unansweredText = $("unansweredText");

const selectedText = $("selectedText");
const optBtns = [
  $("opt0"), $("opt1"), $("opt2"), $("opt3")
];

const resultPanel = $("resultPanel");
const scoreText = $("scoreText");
const badge = $("badge");
const who = $("who");
const whenMonth = $("whenMonth");
const whichType = $("whichType");
const started = $("started");
const finished = $("finished");
const duration = $("duration");
const review = $("review");
const saveStatus = $("saveStatus");

const retryBtn = $("retryBtn");
const backBtn = $("backBtn");


/** ===== layout: keep chat readable (no overlap with fixed bars) ===== */
function updateLayoutVars(){
  const root = document.documentElement;
  const bottomVisible = !bottomBar.classList.contains("hidden");
  const optionVisible = !optionBar.classList.contains("hidden");

  // Measure heights (0 if hidden)
  const bottomH = bottomVisible ? bottomBar.getBoundingClientRect().height : 0;
  const optionH = optionVisible ? optionBar.getBoundingClientRect().height : 0;

  // Lift option bar above bottom bar so they never overlap
  if (optionVisible){
    optionBar.style.transform = bottomVisible ? `translateY(-${bottomH}px)` : "translateY(0px)";
  } else {
    optionBar.style.transform = "translateY(0px)";
  }

  // Update total stack height to reserve space for chat content
  const stackH = optionH + bottomH;
  root.style.setProperty("--stackH", `${Math.max(stackH, 140)}px`);
}

// tiny debounce for resize
let __resizeTimer = null;
window.addEventListener("resize", () => {
  clearTimeout(__resizeTimer);
  __resizeTimer = setTimeout(updateLayoutVars, 50);
});

// ===== state =====
let startedAtISO = "";
let finishedAtISO = "";
let currentType = "A";
let runMonth = "";
let currentQuestions = [];
let currentIndex = 0;
let answers = []; // chosenIndex per question (null if not answered)

// ===== init months (2026-01 ~ 2026-12) =====
(function populate2026Months(){
  const year = 2026;
  for (let m=1; m<=12; m++){
    const mm = String(m).padStart(2, "0");
    const value = `${year}-${mm}`;
    const opt = document.createElement("option");
    opt.value = value;
    opt.textContent = value;
    runMonthSelect.appendChild(opt);
  }
  runMonthSelect.value = `${year}-01`;
})();

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function scrollToBottom(){
  requestAnimationFrame(() => window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" }));
}

function addBubble(who, text){
  const div = document.createElement("div");
  div.className = `bubble ${who}`;
  div.innerHTML = `
    <div class="meta">${who === "bot" ? "ğŸ¤– ë¬¸ì œ ì¶œì œ bot" : "ğŸ™‹ ì‘ì‹œì"}</div>
    <div>${escapeHtml(text)}</div>
  `;
  chat.appendChild(div);
  scrollToBottom();
  return div;
}

function updateBars(){
  const total = currentQuestions.length;
  const answered = answers.filter(v => v !== null && v !== undefined).length;
  const unanswered = total - answered;

  progressText.textContent = `${currentIndex+1}/${total}`;
  unansweredText.textContent = `${unanswered}ê°œ`;

  prevBtn.disabled = currentIndex === 0;

  const isLast = currentIndex === total - 1;
  nextBtn.classList.toggle("hidden", isLast);
  submitBtn.classList.toggle("hidden", !isLast);

  // option selection label
  const sel = answers[currentIndex];
  selectedText.textContent = (sel === null || sel === undefined) ? "ì—†ìŒ" : String.fromCharCode(97 + sel);
  updateLayoutVars();
}

// keep layout in sync
// (bars can change size with content / device)


function renderOptions(){
  const q = currentQuestions[currentIndex];

  optionBar.classList.remove("hidden");
  updateLayoutVars();

  optBtns.forEach((btn, idx) => {
    const prefix = String.fromCharCode(97 + idx); // a,b,c,d
    btn.textContent = `${prefix}. ${q.choices[idx]}`;
    btn.classList.toggle("selected", answers[currentIndex] === idx);

    btn.onclick = () => {
      answers[currentIndex] = idx;

      // visual
      optBtns.forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");

      selectedText.textContent = prefix;

      // echo selection to chat
      addBubble("me", `ì„ íƒ: ${q.choices[idx]}`);

      updateBars();
    };
  });
}

function renderCurrentQuestion(){
  const q = currentQuestions[currentIndex];
  addBubble("bot", `Q${currentIndex+1}. ${q.q}`);
  renderOptions();
  updateBars();
}

function startExam(){
  const nm = nameInput.value.trim();
  if (!nm){
    setupHint.textContent = "âš ï¸ ì‘ì‹œì ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
    return;
  }
  setupHint.textContent = "";

  currentType = typeSelect.value;
  runMonth = runMonthSelect.value;
  startedAtISO = new Date().toISOString();
  finishedAtISO = "";

  currentQuestions = QUESTION_BANK[currentType].slice(0, QUESTIONS_PER_TEST);
  answers = new Array(currentQuestions.length).fill(null);
  currentIndex = 0;

  setupPanel.classList.add("hidden");
  chatPanel.classList.remove("hidden");
  bottomBar.classList.remove("hidden");
  optionBar.classList.remove("hidden");
  updateLayoutVars();

  chat.innerHTML = "";
  resultPanel.classList.add("hidden");
  saveStatus.textContent = "";

  addBubble("bot",
    `ì•ˆë…•í•˜ì„¸ìš”, ${nm}ë‹˜!\nì‘ì‹œì›”: ${runMonth}\níƒ€ì…: ${currentType}\nì´ ${QUESTIONS_PER_TEST}ë¬¸í•­ì…ë‹ˆë‹¤.\në¬¸ì œëŠ” ì±„íŒ…ì— í‘œì‹œë˜ê³ , ë³´ê¸°ëŠ” í•˜ë‹¨ì—ì„œ ì„ íƒí•©ë‹ˆë‹¤.`
  );

  renderCurrentQuestion();
}

function movePrev(){
  if (currentIndex === 0) return;
  currentIndex--;
  renderCurrentQuestion();
}

function moveNext(){
  if (currentIndex >= currentQuestions.length - 1) return;
  currentIndex++;
  renderCurrentQuestion();
}

function grade(){
  let correctCount = 0;
  const details = currentQuestions.map((q, idx) => {
    const chosen = answers[idx];
    const correct = (chosen === q.answer);
    if (correct) correctCount++;
    return {
      no: idx+1,
      question: q.q,
      chosenIndex: chosen,
      chosenText: chosen === null ? "" : q.choices[chosen],
      answerIndex: q.answer,
      answerText: q.choices[q.answer],
      correct
    };
  });

  const score = correctCount * POINT_PER_QUESTION;
  const passed = score >= PASS_SCORE;
  return { score, passed, correctCount, totalQuestions: currentQuestions.length, details };
}

function renderResult(result){
  const nm = nameInput.value.trim();
  const finishedAt = new Date(finishedAtISO);

  scoreText.textContent = String(result.score);
  badge.className = "badge " + (result.passed ? "pass" : "fail");
  badge.textContent = result.passed ? "PASS" : "FAIL";

  who.textContent = nm;
  whenMonth.textContent = runMonth;
  whichType.textContent = currentType;

  started.textContent = new Date(startedAtISO).toLocaleString("ko-KR");
  finished.textContent = finishedAt.toLocaleString("ko-KR");
  const dur = Math.round((finishedAt.getTime() - new Date(startedAtISO).getTime()) / 1000);
  duration.textContent = String(isNaN(dur) ? "" : dur);

  review.innerHTML = "";
  result.details.forEach(d => {
    const div = document.createElement("div");
    div.className = "revItem " + (d.correct ? "good" : "bad");

    const myAns = (d.chosenIndex === null)
      ? `<span class="mono" style="color:var(--warn)">ë¯¸ì‘ë‹µ</span>`
      : `<span class="mono">${escapeHtml(d.chosenText)}</span>`;

    div.innerHTML = `
      <div class="revHead">
        <div style="font-weight:1000;">Q${d.no}. ${escapeHtml(d.question)}</div>
        <div class="badge ${d.correct ? "pass" : "fail"}">${d.correct ? "ì •ë‹µ" : "ì˜¤ë‹µ"}</div>
      </div>
      <div class="small" style="margin-top:8px;">
        ë‚´ ë‹µ: ${myAns}<br/>
        ì •ë‹µ: <span class="mono">${escapeHtml(d.answerText)}</span>
      </div>
    `;
    review.appendChild(div);
  });

  resultPanel.classList.remove("hidden");
  scrollToBottom();
}

async function saveToSheet(payload){
  saveStatus.textContent = "ğŸ’¾ ì‘ë‹µ ì €ì¥ ì¤‘...";
  try{
    const res = await fetch(SUBMIT_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" }, // âœ… preflight ì¤„ì´ê¸°
      body: JSON.stringify(payload),
    });

    let bodyText = "";
    try { bodyText = await res.text(); } catch(_){}

    saveStatus.textContent = res.ok
      ? "âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì €ì¥ ì™„ë£Œ"
      : `âš ï¸ ì €ì¥ ì‹¤íŒ¨(HTTP ${res.status}) ${bodyText ? " / " + bodyText : ""}`;

    return { ok: res.ok, status: res.status, text: bodyText };
  }catch(err){
    saveStatus.textContent = `âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ${err?.message || err}`;
    return { ok:false, error:String(err) };
  }
}

async function submitExam(){
  finishedAtISO = new Date().toISOString();

  const nm = nameInput.value.trim();
  const result = grade();
  const dur = Math.round((new Date(finishedAtISO).getTime() - new Date(startedAtISO).getTime()) / 1000);

  const payload = {
    runMonth,
    type: currentType,
    name: nm,
    startedAt: startedAtISO,
    finishedAt: finishedAtISO,
    durationSec: dur,
    score: result.score,
    passScore: PASS_SCORE,
    result: result.passed ? "PASS" : "FAIL",
    correctCount: result.correctCount,
    totalQuestions: result.totalQuestions,
    answers: result.details
  };

  addBubble("bot", "ì‘ì‹œ ì™„ë£Œ! ê²°ê³¼ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
  optionBar.classList.add("hidden");
  bottomBar.classList.add("hidden");
  updateLayoutVars();

  renderResult(result);
  await saveToSheet(payload);
}

// ===== events =====
startBtn.addEventListener("click", startExam);
prevBtn.addEventListener("click", movePrev);
nextBtn.addEventListener("click", moveNext);
submitBtn.addEventListener("click", submitExam);

retryBtn.addEventListener("click", () => {
  // keep setup values
  setupPanel.classList.remove("hidden");
  chatPanel.classList.add("hidden");
  bottomBar.classList.add("hidden");
  optionBar.classList.add("hidden");
  updateLayoutVars();
  chat.innerHTML = "";
  resultPanel.classList.add("hidden");
  saveStatus.textContent = "";
});

backBtn.addEventListener("click", () => {
  nameInput.value = "";
  typeSelect.value = "A";
  runMonthSelect.value = "2026-01";

  setupPanel.classList.remove("hidden");
  chatPanel.classList.add("hidden");
  bottomBar.classList.add("hidden");
  optionBar.classList.add("hidden");
  updateLayoutVars();
  chat.innerHTML = "";
  resultPanel.classList.add("hidden");
  saveStatus.textContent = "";
});
</script>
</body>
</html>
